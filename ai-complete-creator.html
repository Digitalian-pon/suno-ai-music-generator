<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🎵 AI Complete Music Creator | AI完全音楽クリエイター</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .subtitle {
            text-align: center;
            color: #764ba2;
            font-size: 1.2em;
            margin-top: -15px;
            margin-bottom: 20px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        
        .api-key-area {
            width: 100%;
            min-height: 60px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            background: white;
            color: #333;
            overflow-wrap: break-word;
            word-break: break-all;
            outline: none;
        }
        
        .api-key-area:focus {
            border-color: #667eea;
            background: #fafafa;
        }
        
        .api-key-area[contenteditable="true"]:empty:before {
            content: "ここをタップしてAPIキーを入力";
            color: #999;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .help-text {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .theme-display {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }
        
        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .result-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .api-method-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .method-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .method-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .method-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }
        
        .controls label {
            font-weight: bold;
            color: #667eea;
        }
        
        .controls select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .controls select:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .model-select {
            margin: 10px 0;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 8px;
        }
        
        .model-select label {
            color: #667eea;
            font-weight: bold;
            font-size: 14px;
        }
        
        .model-select select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 AI Complete Creator<br><span style="font-size: 0.6em; color: #764ba2;">AI完全音楽クリエイター</span></h1>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            Claude & Gemini AI 楽曲ジェネレーター（完全AI生成版）
        </div>
        
        <!-- API選択 -->
        <div class="section" style="background: linear-gradient(135deg, #FFE5EC, #E5E5FF);">
            <h3>🤖 AI API選択</h3>
            <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
                <button class="method-btn active" id="apiClaude" onclick="selectAPI('claude')" style="flex: 1; max-width: 200px;">
                    🎭 Claude API
                </button>
                <button class="method-btn" id="apiGemini" onclick="selectAPI('gemini')" style="flex: 1; max-width: 200px;">
                    💎 Gemini API
                </button>
            </div>
            
            <!-- Geminiモデル選択 -->
            <div class="model-select" id="geminiModelSelect" style="display: none;">
                <label>💎 Geminiモデル:</label>
                <select id="geminiModel" onchange="updateGeminiModel()">
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Experimental) - 最新</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash - 高速</option>
                    <option value="gemini-1.5-flash-8b">Gemini 1.5 Flash 8B - 軽量</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro - 高性能</option>
                </select>
            </div>
        </div>
        
        <!-- API設定セクション -->
        <div class="section" id="apiSection">
            <h3 id="apiTitle">🎭 Claude API設定</h3>
            
            <div class="help-text">
                <strong>📱 APIキー入力方法：</strong>
            </div>
            
            <div class="api-method-buttons">
                <button class="method-btn active" id="method1" onclick="selectMethod(1)">
                    ダイアログ入力
                </button>
                <button class="method-btn" id="method2" onclick="selectMethod(2)">
                    直接入力
                </button>
            </div>
            
            <!-- 方法1: プロンプトダイアログ -->
            <div id="method1Content" style="display: block;">
                <button class="btn btn-warning" onclick="promptForApiKey()">
                    📝 APIキーを入力（ダイアログ）
                </button>
                <div id="promptResult" style="margin-top: 10px; font-family: monospace; font-size: 12px; color: #666;"></div>
            </div>
            
            <!-- 方法2: コンテンツ編集可能div -->
            <div id="method2Content" style="display: none;">
                <div class="help-text" style="background: #fff3cd; border-color: #ffc107;">
                    下の枠内をタップして、APIキーを直接入力または貼り付けてください
                </div>
                <div 
                    id="apiKeyDiv" 
                    class="api-key-area"
                    contenteditable="true"
                    spellcheck="false"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    oninput="onApiKeyDivChange()"
                ></div>
                <div id="divCharCount" style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">0文字</div>
            </div>
            
            <!-- 共通ボタン -->
            <button class="btn" onclick="testConnection()" id="testBtn">
                🔌 接続テスト
            </button>
            
            <button class="btn btn-danger" onclick="clearApiKey()">
                🗑️ APIキークリア
            </button>
            
            <div id="apiStatus"></div>
        </div>
        
        <!-- テーマ生成 -->
        <div class="section">
            <h3>🎯 楽曲テーマ（完全AI生成）</h3>
            
            <!-- 言語切り替え -->
            <div style="display: flex; gap: 10px; margin-bottom: 15px; justify-content: center;">
                <button class="method-btn active" id="langJa" onclick="switchLanguage('ja')" style="width: 100px;">
                    🇯🇵 日本語
                </button>
                <button class="method-btn" id="langEn" onclick="switchLanguage('en')" style="width: 100px;">
                    🇺🇸 English
                </button>
            </div>
            
            <!-- カテゴリー選択（オプション） -->
            <div style="margin-bottom: 15px;">
                <label style="color: #667eea; font-weight: bold;">テーマカテゴリー（オプション）:</label>
                <select id="themeCategory" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                    <option value="random">🎲 ランダム（AIにお任せ）</option>
                    <option value="romance">💕 恋愛・ロマンス</option>
                    <option value="friendship">🤝 友情・絆</option>
                    <option value="dream">🌟 夢・挑戦</option>
                    <option value="daily">☀️ 日常・生活</option>
                    <option value="digital">💻 デジタル・テクノロジー</option>
                    <option value="fantasy">🦄 ファンタジー・SF</option>
                    <option value="dark">🌙 ダーク・シリアス</option>
                    <option value="nostalgia">📼 ノスタルジー・レトロ</option>
                    <option value="adventure">🏔️ 冒険・アクション</option>
                    <option value="mystery">🔍 ミステリー・サスペンス</option>
                    <option value="comedy">😄 コメディ・ユーモア</option>
                    <option value="sports">⚽ スポーツ・競技</option>
                    <option value="art">🎨 音楽・アート</option>
                    <option value="school">🎓 学園・スクール</option>
                    <option value="work">💼 仕事・ビジネス</option>
                    <option value="travel">✈️ 旅行・観光</option>
                    <option value="food">🍜 食べ物・グルメ</option>
                    <option value="pet">🐕 ペット・動物</option>
                    <option value="nature">🌿 自然・風景</option>
                </select>
            </div>
            
            <!-- テーマ生成ボタン -->
            <button class="btn btn-secondary" onclick="generateAITheme()" id="aiThemeBtn">
                🤖 AIテーマ生成（完全オリジナル）
            </button>
            
            <!-- テーマ表示エリア（編集可能） -->
            <div class="theme-display" id="themeDisplay" contenteditable="true" style="cursor: text;">
                テーマを生成してください
            </div>
            <div style="text-align: center; margin-top: 5px; color: #666; font-size: 12px;">
                ✏️ クリックして編集可能
            </div>
        </div>
        
        <!-- 楽曲生成 -->
        <div class="section">
            <button class="btn" onclick="generateSong()" id="generateBtn" disabled>
                🚀 3分楽曲を生成（要API接続）
            </button>
        </div>

        <!-- MV用 Text to Video プロンプト生成 -->
        <div class="section" style="background: linear-gradient(135deg, #FFE5E5, #E5F5FF);">
            <h3>🎬 MV用 Text to Video プロンプト生成</h3>
            <div class="help-text" style="background: #E5F5FF; border-color: #667eea;">
                楽曲テーマからミュージックビデオ用の動画生成プロンプトをAIが作成します
            </div>

            <!-- 動画スタイル選択 -->
            <div style="margin: 15px 0;">
                <label style="color: #667eea; font-weight: bold;">動画スタイル:</label>
                <select id="videoStyle" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 8px; margin-top: 5px;">
                    <option value="cinematic">🎥 映画的・シネマティック</option>
                    <option value="anime">🎨 アニメーション風</option>
                    <option value="abstract">🌈 抽象的・アート</option>
                    <option value="realistic">📸 リアル・実写風</option>
                    <option value="retro">📼 レトロ・ビンテージ</option>
                    <option value="futuristic">🚀 未来的・SF</option>
                    <option value="minimalist">⚪ ミニマル・シンプル</option>
                    <option value="vibrant">🌟 カラフル・鮮やか</option>
                </select>
            </div>

            <!-- プロンプト生成ボタン -->
            <button class="btn btn-secondary" onclick="generateVideoPrompt()" id="videoPromptBtn" disabled>
                🎬 MV用プロンプト生成（要テーマ＆API接続）
            </button>

            <!-- プロンプト表示エリア（編集可能） -->
            <div id="videoPromptDisplay" contenteditable="true" style="
                min-height: 100px;
                padding: 15px;
                margin: 15px 0;
                border: 2px solid #ddd;
                border-radius: 10px;
                background: white;
                font-family: 'Segoe UI', Arial, sans-serif;
                font-size: 14px;
                color: #333;
                cursor: text;
                display: none;
            ">
            </div>

            <!-- コピーボタン -->
            <button class="btn btn-warning" onclick="copyVideoPrompt()" id="copyVideoBtn" style="display: none;">
                📋 プロンプトをコピー
            </button>
        </div>

        <!-- 結果表示 -->
        <div id="results"></div>
    </div>
    
    <script>
        // グローバル変数
        let apiKey = '';
        let apiConnected = false;
        let currentTheme = '';
        let isGenerating = false;
        let selectedMethod = 1;
        let currentData = {};
        let selectedAPI = 'claude';
        let currentLanguage = 'ja';
        let geminiModel = 'gemini-2.0-flash-exp';
        let generatedThemes = [];
        
        // 初期化
        window.onload = function() {
            const savedClaude = localStorage.getItem('claudeApiKey');
            const savedGemini = localStorage.getItem('geminiApiKey');
            
            if (savedClaude) {
                selectedAPI = 'claude';
                apiKey = savedClaude;
                displayApiKey();
                setTimeout(() => testConnection(), 1000);
            } else if (savedGemini) {
                selectedAPI = 'gemini';
                selectAPI('gemini');
                apiKey = savedGemini;
                displayApiKey();
                setTimeout(() => testConnection(), 1000);
            }

            // 保存されたGeminiモデルを復元
            const savedGeminiModel = localStorage.getItem('selectedGeminiModel');
            if (savedGeminiModel) {
                geminiModel = savedGeminiModel;
                document.getElementById('geminiModel').value = savedGeminiModel;
            }

            // テーマ編集機能の初期化
            const themeDisplay = document.getElementById('themeDisplay');
            if (themeDisplay) {
                themeDisplay.addEventListener('input', function() {
                    currentTheme = this.textContent.replace(/^[🔥🎲]\s*/, '');
                });
                
                themeDisplay.addEventListener('focus', function() {
                    if (this.textContent === 'テーマを生成してください') {
                        this.textContent = '';
                    }
                });
                
                themeDisplay.addEventListener('blur', function() {
                    if (this.textContent === '') {
                        this.textContent = 'テーマを生成してください';
                    }
                });
            }
        };
        
        // API選択
        function selectAPI(api) {
            selectedAPI = api;
            document.getElementById('apiClaude').classList.remove('active');
            document.getElementById('apiGemini').classList.remove('active');
            document.getElementById('api' + api.charAt(0).toUpperCase() + api.slice(1)).classList.add('active');
            
            const apiTitle = document.getElementById('apiTitle');
            const geminiModelSelect = document.getElementById('geminiModelSelect');
            
            if (api === 'claude') {
                apiTitle.innerHTML = '🎭 Claude API設定';
                apiKey = localStorage.getItem('claudeApiKey') || '';
                if (geminiModelSelect) geminiModelSelect.style.display = 'none';
            } else {
                apiTitle.innerHTML = '💎 Gemini API設定';
                apiKey = localStorage.getItem('geminiApiKey') || '';
                if (geminiModelSelect) geminiModelSelect.style.display = 'block';
            }
            
            displayApiKey();
            apiConnected = false;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('apiStatus').innerHTML = '';
        }
        
        // Geminiモデル更新
        function updateGeminiModel() {
            geminiModel = document.getElementById('geminiModel').value;
            localStorage.setItem('selectedGeminiModel', geminiModel);
            console.log('Gemini model updated to:', geminiModel);
        }
        
        // 言語切り替え
        function switchLanguage(lang) {
            currentLanguage = lang;
            document.getElementById('langJa').classList.toggle('active', lang === 'ja');
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            
            const categorySelect = document.getElementById('themeCategory');
            if (lang === 'en') {
                categorySelect.innerHTML = `
                    <option value="random">🎲 Random (AI Choice)</option>
                    <option value="romance">💕 Romance</option>
                    <option value="friendship">🤝 Friendship</option>
                    <option value="dream">🌟 Dreams & Ambitions</option>
                    <option value="daily">☀️ Daily Life</option>
                    <option value="digital">💻 Digital & Tech</option>
                    <option value="fantasy">🦄 Fantasy & Sci-Fi</option>
                    <option value="dark">🌙 Dark & Serious</option>
                    <option value="nostalgia">📼 Nostalgia & Retro</option>
                    <option value="adventure">🏔️ Adventure & Action</option>
                    <option value="mystery">🔍 Mystery & Suspense</option>
                    <option value="comedy">😄 Comedy & Humor</option>
                    <option value="sports">⚽ Sports</option>
                    <option value="art">🎨 Music & Art</option>
                    <option value="school">🎓 School Life</option>
                    <option value="work">💼 Work & Business</option>
                    <option value="travel">✈️ Travel</option>
                    <option value="food">🍜 Food & Cuisine</option>
                    <option value="pet">🐕 Pets & Animals</option>
                    <option value="nature">🌿 Nature & Landscape</option>
                `;
            } else {
                categorySelect.innerHTML = `
                    <option value="random">🎲 ランダム（AIにお任せ）</option>
                    <option value="romance">💕 恋愛・ロマンス</option>
                    <option value="friendship">🤝 友情・絆</option>
                    <option value="dream">🌟 夢・挑戦</option>
                    <option value="daily">☀️ 日常・生活</option>
                    <option value="digital">💻 デジタル・テクノロジー</option>
                    <option value="fantasy">🦄 ファンタジー・SF</option>
                    <option value="dark">🌙 ダーク・シリアス</option>
                    <option value="nostalgia">📼 ノスタルジー・レトロ</option>
                    <option value="adventure">🏔️ 冒険・アクション</option>
                    <option value="mystery">🔍 ミステリー・サスペンス</option>
                    <option value="comedy">😄 コメディ・ユーモア</option>
                    <option value="sports">⚽ スポーツ・競技</option>
                    <option value="art">🎨 音楽・アート</option>
                    <option value="school">🎓 学園・スクール</option>
                    <option value="work">💼 仕事・ビジネス</option>
                    <option value="travel">✈️ 旅行・観光</option>
                    <option value="food">🍜 食べ物・グルメ</option>
                    <option value="pet">🐕 ペット・動物</option>
                    <option value="nature">🌿 自然・風景</option>
                `;
            }
        }
        
        // 入力方法選択
        function selectMethod(method) {
            selectedMethod = method;
            
            document.querySelectorAll('.method-btn').forEach(btn => {
                if (btn.id.startsWith('method')) {
                    btn.classList.remove('active');
                }
            });
            document.getElementById('method' + method).classList.add('active');
            
            document.getElementById('method1Content').style.display = method === 1 ? 'block' : 'none';
            document.getElementById('method2Content').style.display = method === 2 ? 'block' : 'none';
        }
        
        // APIキー入力（ダイアログ）
        function promptForApiKey() {
            const apiName = selectedAPI === 'claude' ? 'Claude' : 'Gemini';
            const format = selectedAPI === 'claude' ? 'sk-ant-api...で始まる100文字程度' : 'AIzaSy...で始まる40文字程度';
            
            const input = prompt(`${apiName} APIキーを入力してください（${format}）:`);
            if (input && input.trim()) {
                apiKey = input.trim();
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                displayApiKey();
                document.getElementById('apiStatus').innerHTML = '<div class="status warning">APIキーを保存しました。接続テストを実行してください。</div>';
            }
        }
        
        // APIキー入力変更時
        function onApiKeyDivChange() {
            const div = document.getElementById('apiKeyDiv');
            const text = div.textContent || div.innerText || '';
            const count = document.getElementById('divCharCount');
            
            count.textContent = text.length + '文字';
            
            const isValid = (selectedAPI === 'claude' && text.startsWith('sk-ant-api') && text.length >= 100) ||
                           (selectedAPI === 'gemini' && text.startsWith('AIzaSy') && text.length >= 39);
            
            if (isValid) {
                apiKey = text.trim();
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                count.innerHTML = text.length + '文字 <span style="color: green;">✅</span>';
            } else if (text.length > 0) {
                count.innerHTML = text.length + '文字 <span style="color: orange;">⚠️</span>';
            }
        }
        
        // APIキー表示
        function displayApiKey() {
            if (apiKey) {
                const masked = apiKey.substring(0, 10) + '...' + apiKey.substring(apiKey.length - 5);
                document.getElementById('promptResult').textContent = 'APIキー: ' + masked;
                document.getElementById('apiKeyDiv').textContent = apiKey;
                onApiKeyDivChange();
            }
        }
        
        // 文字化けエラーを修正する処理
        function fixTextEncoding(text) {
            if (!text) return '';

            // ダイヤモンド型文字化け記号を修正
            return text
                .replace(/\uFFFD/g, '') // Unicode replacement character
                .replace(/\u00EF\u00BF\u00BD/g, '') // UTF-8 byte sequence
                .replace(/�/g, '') // Question mark in diamond
                .replace(/\uffff/g, '') // Invalid character
                .trim();
        }


        // APIキークリア
        function clearApiKey() {
            if (confirm('APIキーをクリアしますか？')) {
                apiKey = '';
                localStorage.removeItem(selectedAPI + 'ApiKey');
                apiConnected = false;
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('apiStatus').innerHTML = '';
                document.getElementById('promptResult').textContent = '';
                document.getElementById('apiKeyDiv').textContent = '';
                document.getElementById('divCharCount').textContent = '0文字';
                alert('APIキーをクリアしました');
            }
        }
        
        // API接続テスト
        async function testConnection() {
            const status = document.getElementById('apiStatus');
            const testBtn = document.getElementById('testBtn');
            const generateBtn = document.getElementById('generateBtn');
            
            if (selectedMethod === 2) {
                const div = document.getElementById('apiKeyDiv');
                const text = (div.textContent || div.innerText || '').trim();
                if (text.startsWith('sk-ant-api') || text.startsWith('AIzaSy')) {
                    apiKey = text;
                }
            }
            
            if (!apiKey) {
                status.innerHTML = '<div class="status error">❌ APIキーを入力してください</div>';
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = '🔄 テスト中...';
            status.innerHTML = '<div class="status warning">⏳ 接続テスト中...</div>';
            
            try {
                const endpoint = selectedAPI === 'claude' ? '/api/claude' : '/api/gemini';
                const requestBody = {
                    apiKey: apiKey,
                    prompt: 'Hello test',
                    temperature: 0.1
                };
                
                if (selectedAPI === 'gemini') {
                    requestBody.model = geminiModel;
                }
                
                // 動的にベースURLを取得（localhost または 外部IP）
                const baseUrl = window.location.origin;
                const response = await fetch(baseUrl + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                const data = await response.json();
                
                if (response.ok && (data.content || data.candidates)) {
                    apiConnected = true;
                    generateBtn.disabled = false;
                    status.innerHTML = '<div class="status success">✅ 接続成功！AI生成が利用可能です</div>';
                    localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                } else {
                    throw new Error(data.error?.message || data.error || 'Connection failed');
                }
            } catch (error) {
                apiConnected = false;
                generateBtn.disabled = true;
                status.innerHTML = `<div class="status error">❌ 接続失敗: ${error.message}</div>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '🔌 接続テスト';
            }
        }
        
        // AIテーマ生成（完全AI生成）
        async function generateAITheme() {
            const btn = document.getElementById('aiThemeBtn');
            const display = document.getElementById('themeDisplay');
            
            if (!apiConnected) {
                alert('先にAPI接続テストを成功させてください');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '🤖 生成中...';
            display.textContent = 'AIが独創的なテーマを考案中...';
            
            try {
                const category = document.getElementById('themeCategory').value;
                const randomSeed = Math.floor(Math.random() * 10000);
                
                // カテゴリーの設定
                let categoryText = '';
                if (category !== 'random') {
                    const categoryMap = {
                        'romance': currentLanguage === 'ja' ? '恋愛・ロマンス' : 'Romance',
                        'friendship': currentLanguage === 'ja' ? '友情・絆' : 'Friendship',
                        'dream': currentLanguage === 'ja' ? '夢・挑戦' : 'Dreams & Ambitions',
                        'daily': currentLanguage === 'ja' ? '日常・生活' : 'Daily Life',
                        'digital': currentLanguage === 'ja' ? 'デジタル・テクノロジー' : 'Digital & Tech',
                        'fantasy': currentLanguage === 'ja' ? 'ファンタジー・SF' : 'Fantasy & Sci-Fi',
                        'dark': currentLanguage === 'ja' ? 'ダーク・シリアス' : 'Dark & Serious',
                        'nostalgia': currentLanguage === 'ja' ? 'ノスタルジー・レトロ' : 'Nostalgia & Retro',
                        'adventure': currentLanguage === 'ja' ? '冒険・アクション' : 'Adventure & Action',
                        'mystery': currentLanguage === 'ja' ? 'ミステリー・サスペンス' : 'Mystery & Suspense',
                        'comedy': currentLanguage === 'ja' ? 'コメディ・ユーモア' : 'Comedy & Humor',
                        'sports': currentLanguage === 'ja' ? 'スポーツ・競技' : 'Sports',
                        'art': currentLanguage === 'ja' ? '音楽・アート' : 'Music & Art',
                        'school': currentLanguage === 'ja' ? '学園・スクール' : 'School Life',
                        'work': currentLanguage === 'ja' ? '仕事・ビジネス' : 'Work & Business',
                        'travel': currentLanguage === 'ja' ? '旅行・観光' : 'Travel',
                        'food': currentLanguage === 'ja' ? '食べ物・グルメ' : 'Food & Cuisine',
                        'pet': currentLanguage === 'ja' ? 'ペット・動物' : 'Pets & Animals',
                        'nature': currentLanguage === 'ja' ? '自然・風景' : 'Nature & Landscape'
                    };
                    categoryText = categoryMap[category] || '';
                }
                
                // 完全AI創造プロンプト（革命的創造性）

                // 人の心に響く感情的要素を生成
                // randomSeed already declared above, reusing same value

                // 感動的な人間体験の要素
                const humanExperiences = [
                    '初恋の思い出', '家族の温かさ', '友達との絆', '故郷への想い', '夢への挑戦',
                    '別れの切なさ', '再会の喜び', '成長の実感', '感謝の気持ち', '希望の光',
                    '青春の1ページ', '大切な約束', '心の支え', '新しい出発', '変わらぬ愛',
                    '懐かしい風景', '笑顔の記憶', '涙の意味', '勇気の源', '優しい言葉'
                ];
                const randomExperience = humanExperiences[Math.floor(Math.random() * humanExperiences.length)];

                // 感情の深さを表現する修飾語
                const emotionalDepth = [
                    '心の奥底の', '魂を揺さぶる', '涙があふれる', '胸が熱くなる', '心が躍る',
                    '懐かしくて切ない', '温かくて優しい', '力強く前向きな', '静かで深い', '純粋で美しい'
                ];
                const randomEmotion = emotionalDepth[Math.floor(Math.random() * emotionalDepth.length)];

                const prompt = currentLanguage === 'ja' ?
                    `あなたは世界中で愛される楽曲を生み出す作詞家です。${categoryText ? categoryText + 'をテーマに、' : ''}多くの人の心に響く、完全にオリジナルな楽曲テーマを考えてください。

🎯 テーマの方向性:
「${randomExperience}」から感じる${randomEmotion}感情を、あなた独自の言葉で表現してください。

✨ 大切な要素:
- 人生の普遍的な感情や大切な瞬間を描く
- 前向きで希望に満ちた内容
- 人々に勇気や感動を与える
- まだ誰も使ったことのない新鮮な言葉の組み合わせ
- 4-8文字のシンプルで力強い日本語

⚠️ 重要: 既存の楽曲タイトルや一般的なフレーズは避け、あなた自身の感性で新しい言葉を生み出してください。

📝 出力: オリジナルのテーマ1つ。説明不要。
${generatedThemes.length > 0 ? `
避けるべき過去作: ${generatedThemes.slice(-5).join('、')}` : ''}` :
                    `You are a songwriter who creates songs loved worldwide. Create a completely original ${categoryText ? categoryText.toLowerCase() : 'powerful and moving'} music theme that resonates with many people.

🎯 Theme Direction:
Express ${randomEmotion} emotions from "${randomExperience}" using your own unique words.

✨ Essential Elements:
- Capture universal human emotions and precious life moments
- Positive and hopeful content
- Give courage and inspiration to people
- Fresh word combinations never used before
- 2-5 simple yet powerful words in English

⚠️ Important: Avoid existing song titles and common phrases. Create something truly new from your own sensitivity.

📝 Output: One original theme. No explanation.
${generatedThemes.length > 0 ? `
Avoid these past themes: ${generatedThemes.slice(-5).join(', ')}` : ''}`;
                
                let theme = await callAI(prompt);
                theme = theme.trim().replace(/[\n\r]/g, '').replace(/^[「『"']|[」』"']$/g, '');
                
                const maxLength = currentLanguage === 'ja' ? 15 : 30;
                if (theme.length > maxLength) {
                    theme = theme.substring(0, maxLength);
                }
                
                currentTheme = theme;
                display.textContent = '🔥 ' + currentTheme;

                generatedThemes.push(theme);
                if (generatedThemes.length > 10) {
                    generatedThemes.shift();
                }

                // ビデオプロンプトボタンを有効化
                if (apiConnected && currentTheme) {
                    document.getElementById('videoPromptBtn').disabled = false;
                }

            } catch (error) {
                console.error('AI theme generation failed:', error);
                alert('AIテーマ生成に失敗しました。API接続を確認してください。');
                display.textContent = 'テーマ生成エラー';
            } finally {
                btn.disabled = false;
                btn.textContent = '🤖 AIテーマ生成（完全オリジナル）';
            }
        }
        
        // 楽曲生成
        async function generateSong() {
            if (!currentTheme) {
                alert('先にテーマを生成してください');
                return;
            }
            
            if (!apiConnected) {
                alert('先にAPI接続テストを成功させてください');
                return;
            }
            
            if (isGenerating) return;
            
            const btn = document.getElementById('generateBtn');
            const results = document.getElementById('results');
            
            isGenerating = true;
            btn.disabled = true;
            btn.textContent = '🔄 生成中...';
            
            results.innerHTML = '<div class="status warning">🎵 楽曲を生成中...</div>';
            
            try {
                // ランダム性を高めるための要素
                const uniqueSeed = Date.now() + Math.random();
                const styleVariations = [
                    'ポエティックで抽象的な', '都会的でモダンな', '自然と調和した',
                    'エモーショナルで切ない', 'ミステリアスで幻想的な', '力強く前向きな',
                    'ノスタルジックで温かい', '実験的で斬新な', 'メロウで静かな',
                    'エネルギッシュで躍動的な', '孤独で内省的な', '希望に満ちた明るい'
                ];
                const randomStyle = styleVariations[Math.floor(Math.random() * styleVariations.length)];

                const wordCombos = [
                    'ひらがな2文字+カタカナ2文字', 'カタカナ2文字+ひらがな2文字',
                    'ひらがな3文字+カタカナ1文字', 'カタカナ1文字+漢字2文字+ひらがな1文字',
                    'ひらがな1文字+カタカナ3文字', '漢字1文字+ひらがな2文字+カタカナ1文字',
                    'カタカナ3文字+ひらがな1文字', 'ひらがな2文字+漢字1文字+カタカナ1文字'
                ];
                const randomCombo = wordCombos[Math.floor(Math.random() * wordCombos.length)];

                // タイトル生成
                const titleJa = await callAI(`テーマ「${currentTheme}」から、まだ誰も使ったことのない完全にオリジナルな楽曲タイトルを創造してください。

🎵 タイトルの方向性:
- ${randomStyle}雰囲気を表現する
- 3-8文字の美しい日本語
- テーマの核心を捉えた独創的な言葉
- 聞いた瞬間に心に響き、記憶に残る
- ポジティブで希望を感じさせる

✨ 創造のヒント:
- ひらがな、カタカナ、漢字を自由に組み合わせる
- 既存の楽曲タイトルとは全く異なる新鮮な表現を
- テーマの本質を、あなた独自の感性で言語化する
- 言葉の響きと意味の両方が美しいタイトルを

📝 出力: 完全オリジナルのタイトル1つ。説明不要。`);

                const titleEn = await callAI(`Create a completely original and unprecedented song title for the theme "${currentTheme}".

🎵 Title Direction:
- Express ${randomStyle} atmosphere
- 2-5 powerful words in English
- Capture the essence of the theme with unique words
- Instantly touching and memorable
- Positive and hopeful feeling

✨ Creative Hints:
- Avoid all common song title patterns
- Create fresh word combinations never heard before
- Express the theme's core through your own unique voice
- Balance beautiful sound with meaningful message

📝 Output: One completely original title. No explanation.`);
                
                // 日本語歌詞生成
                const lyricsJP = await callAI(`テーマ「${currentTheme}」で、世界中の人々の心に深く響く、完全にオリジナルな日本語歌詞を創作してください。

🎯 歌詞の使命:
聞く人に希望と勇気を与え、困難を乗り越える力を感じさせる歌詞を書いてください。
人生の大切な瞬間を描き、人々の心を一つにし、明日への希望を描いてください。

🎵 楽曲構成（約3分）:
[Intro] - 心を開く導入部
[Verse 1] - 物語の始まり、状況設定
[Pre-Chorus] - 感情が高まっていく
[Chorus] - 最も伝えたいメッセージ（印象的で覚えやすく）
[Verse 2] - 物語の展開、深まり
[Pre-Chorus] - 再び感情の高まり
[Chorus] - 核心メッセージの繰り返し
[Bridge] - 新しい視点や転換点
[Final Chorus] - 最高潮の感動
[Outro] - 希望を残して締めくくる

✨ 創作のポイント:
- 自然で美しい日本語を使う
- 心に響く独自の表現を見つける
- サビは覚えやすく、力強く
- ストーリーに一貫性を持たせる
- 既存の楽曲とは異なる、あなただけの言葉で

📝 出力: 構成タグ付きの歌詞のみ。前置き・説明は一切不要。`);

                // 英語歌詞生成
                const lyricsEN = await callAI(`Write completely original English lyrics for the theme "${currentTheme}" that deeply touch people's hearts worldwide.

🎯 Lyrics Mission:
Create lyrics that give hope and courage, make people feel strength to overcome challenges.
Capture precious life moments, unite hearts, and paint tomorrow's hope.

🎵 Song Structure (approx. 3 minutes):
[Intro] - Opening that draws listeners in
[Verse 1] - Story beginning, setting the scene
[Pre-Chorus] - Building emotional momentum
[Chorus] - Core message (memorable and impactful)
[Verse 2] - Story development, deeper meaning
[Pre-Chorus] - Emotional build again
[Chorus] - Repeat the core message
[Bridge] - New perspective or turning point
[Final Chorus] - Peak emotional moment
[Outro] - End with lingering hope

✨ Creative Points:
- Use natural, beautiful English
- Find unique expressions that touch hearts
- Make the chorus memorable and powerful
- Keep the story coherent throughout
- Use your own voice, different from existing songs

📝 Output: Lyrics with structure tags only. No preamble or explanation.`);

                // スタイル生成 - シンプル版
                const style = await callAI(`"${currentTheme}"のSuno AI用音楽スタイルを生成してください。

🎵 音楽スタイル指定:
- ${currentTheme}に適したジャンル名
- シンプルで分かりやすいスタイル表現
- 10語以内の簡潔な表現

出力例: "J-Pop バラード"、"Rock アンセム"、"Electronic チルアウト"

出力: 音楽スタイル（10語以内）`);

                // アートワーク生成 - シンプル版（v7デフォルト）
                const artwork = await callAI(`"${currentTheme}"のMidjourneyプロンプト（1つだけ）を生成してください。

🎨 Midjourneyプロンプト要件:
- ${currentTheme}を表現する簡潔な英語プロンプト
- 10語以内
- アルバムアートに適した内容

出力: [プロンプト] --v 7`);
                
                // 歌詞から説明文のみを除去する処理（歌詞は保持）
                function cleanLyrics(lyrics) {
                    let cleaned = lyrics.trim();

                    // 明確な説明文のみを除去（歌詞は保持）
                    const explanationPatterns = [
                        /^.*?この歌詞は.*?を表現しています.*?\n/gm,
                        /^.*?テーマについて.*?です.*?\n/gm,
                        /^.*?以下の歌詞.*?になります.*?\n/gm,
                        /^.*?This song is about.*?\n/gm,
                        /^.*?The lyrics explore.*?\n/gm,
                        /^.*?represents the theme.*?\n/gm,
                        /^.*?以下が.*?の歌詞です.*?\n/gm,
                        /^.*?Here are the lyrics.*?\n/gm,
                    ];

                    explanationPatterns.forEach(pattern => {
                        cleaned = cleaned.replace(pattern, '');
                    });

                    // 最初の構造タグの前にある説明文のみを除去（とても保守的に）
                    const firstTagIndex = cleaned.search(/\[/);
                    if (firstTagIndex > 0) {
                        const beforeTag = cleaned.substring(0, firstTagIndex);
                        // 短い説明的なテキストのみを除去（歌詞の内容は保持）
                        if (beforeTag.includes('歌詞') || beforeTag.includes('テーマ') || beforeTag.includes('about') || beforeTag.includes('lyrics')) {
                            cleaned = cleaned.substring(firstTagIndex);
                        }
                    }

                    // 先頭と末尾の余分な改行を除去（1つの改行は残す）
                    cleaned = cleaned.replace(/^\n+/, '').replace(/\n+$/, '').trim();

                    // 歌詞が短すぎる場合は元の歌詞を返す（安全策）
                    if (cleaned.length < 30) {
                        return lyrics.trim();
                    }

                    return cleaned;
                }

                currentData = {
                    titleJa: fixTextEncoding(titleJa.trim()),
                    titleEn: fixTextEncoding(titleEn.trim()),
                    lyricsJP: fixTextEncoding(cleanLyrics(lyricsJP)),
                    lyricsEN: fixTextEncoding(cleanLyrics(lyricsEN)),
                    style: fixTextEncoding(style.trim()),
                    artwork: fixTextEncoding(artwork.trim())
                };
                
                displayResults(currentData);
                
            } catch (error) {
                results.innerHTML = `<div class="status error">❌ 生成エラー: ${error.message}</div>`;
            } finally {
                isGenerating = false;
                btn.disabled = false;
                btn.textContent = '🚀 3分楽曲を生成（要API接続）';
            }
        }
        
        // AI API呼び出し
        async function callAI(prompt) {
            const endpoint = selectedAPI === 'claude' ? '/api/claude' : '/api/gemini';
            
            const requestBody = {
                apiKey: apiKey,
                prompt: prompt,
                temperature: 0.9
            };
            
            if (selectedAPI === 'gemini') {
                requestBody.model = geminiModel;
            }
            
            // 動的にベースURLを取得（localhost または 外部IP）
            const baseUrl = window.location.origin;
            const response = await fetch(baseUrl + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'API Error');
            }
            
            if (selectedAPI === 'claude' && data.content && data.content[0]) {
                return fixTextEncoding(data.content[0].text);
            } else if (selectedAPI === 'gemini' && data.candidates && data.candidates[0]) {
                return fixTextEncoding(data.candidates[0].content.parts[0].text);
            } else {
                throw new Error('No response from API');
            }
        }
        
        // 結果表示
        function displayResults(content) {
            const results = document.getElementById('results');

            results.innerHTML = `
                <div class="result-box">
                    <div class="result-header">
                        🎵 楽曲タイトル（日本語）
                        <button class="copy-btn" onclick="copyTitleJa()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="titleJaContent">${content.titleJa}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        🎵 Song Title (English)
                        <button class="copy-btn" onclick="copyTitleEn()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="titleEnContent">${content.titleEn}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        🎌 日本語歌詞（3分楽曲用）
                        <button class="copy-btn" onclick="copyLyricsJP()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="lyricsJPContent">${content.lyricsJP}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        🇺🇸 英語歌詞（3分楽曲用）
                        <button class="copy-btn" onclick="copyLyricsEN()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="lyricsENContent">${content.lyricsEN}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        🎨 音楽スタイル
                        <button class="copy-btn" onclick="copyStyle()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="styleContent">${content.style}</div>
                </div>

                <div class="result-box">
                    <div class="result-header">
                        🖼️ アートワーク
                        <button class="copy-btn" onclick="copyArtwork()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="artworkContent">${content.artwork}</div>
                </div>
            `;
        }
        
        // コピー機能
        function copyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('📋 コピーしました！');
            } catch (err) {
                alert('コピーに失敗しました。手動でコピーしてください。');
            }
            
            document.body.removeChild(textArea);
        }
        
        function copyTitleJa() {
            copyText(document.getElementById('titleJaContent').textContent);
        }
        
        function copyTitleEn() {
            copyText(document.getElementById('titleEnContent').textContent);
        }
        
        function copyLyricsJP() {
            copyText(document.getElementById('lyricsJPContent').textContent);
        }

        function copyLyricsEN() {
            copyText(document.getElementById('lyricsENContent').textContent);
        }
        
        function copyStyle() {
            copyText(document.getElementById('styleContent').textContent);
        }
        
        function copyArtwork() {
            copyText(document.getElementById('artworkContent').textContent);
        }
        
        // Midjourneyプロンプト更新
        function updateMjPrompt() {
            if (!currentData.artwork) return;

            const aspectRatio = document.getElementById('aspectRatio').value;
            const model = document.getElementById('model').value;
            const prompt = `${currentData.artwork} --ar ${aspectRatio} --${model}`;

            document.getElementById('artworkContent').textContent = prompt;
        }

        // MV用 Text to Video プロンプト生成
        async function generateVideoPrompt() {
            // currentTheme変数を使用（表示テキストではなく）
            const theme = currentTheme || document.getElementById('themeDisplay').textContent.trim().replace(/^🔥\s*/, '');

            console.log('Video Prompt - Theme:', theme);
            console.log('Video Prompt - currentTheme:', currentTheme);

            if (!theme || theme === 'テーマを生成してください') {
                alert('先に楽曲テーマを生成してください');
                return;
            }

            if (!apiConnected) {
                alert('APIに接続してください');
                return;
            }

            const btn = document.getElementById('videoPromptBtn');
            btn.disabled = true;
            btn.textContent = '🎬 プロンプト生成中...';

            const videoStyle = document.getElementById('videoStyle').value;
            const styleDescriptions = {
                'cinematic': '映画的で感動的なシネマティック映像。ドラマチックな照明、美しい構図、深みのある色彩',
                'anime': 'アニメーション風の鮮やかで表現力豊かな映像。キャラクター重視、ダイナミックな動き',
                'abstract': '抽象的でアーティスティックな映像。形、色、動きの芸術的表現',
                'realistic': 'リアルで実写的な映像。自然な照明、現実的なシーン、ドキュメンタリー風',
                'retro': 'レトロでビンテージな映像。懐かしい雰囲気、フィルムグレイン、ノスタルジック',
                'futuristic': '未来的でSF風の映像。先進的なビジュアル、テクノロジー感、ネオン',
                'minimalist': 'ミニマルでシンプルな映像。クリーンなデザイン、余白の美、洗練された構成',
                'vibrant': 'カラフルで鮮やかな映像。明るい色彩、エネルギッシュ、ポップ'
            };

            try {
                const promptText = `You are a professional music video director and AI video prompt specialist.

Create a detailed text-to-video prompt for a music video based on this song theme:
"${theme}"

Video Style: ${styleDescriptions[videoStyle]}
Language: ${currentLanguage === 'ja' ? 'Japanese' : 'English'}

Please create a detailed video prompt that includes:
1. Visual concept and overall atmosphere
2. Key scenes and transitions (at least 3-4 scenes)
3. Color palette and lighting
4. Camera movements and angles
5. Visual effects and mood

Format the output as a single, cohesive text-to-video prompt (200-300 words) that can be directly used with AI video generation tools like Runway, Pika Labs, or similar platforms.

Make it vivid, specific, and cinematically compelling. Focus on visual storytelling that matches the song's emotional tone.`;

                console.log('Sending API request...');
                let videoPrompt;

                if (selectedAPI === 'claude') {
                    const response = await fetch('http://localhost:3000/api/claude', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: promptText, apiKey })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error('API request failed: ' + response.status);
                    }
                    const data = await response.json();
                    videoPrompt = data.response;

                } else {
                    const response = await fetch('http://localhost:3000/api/gemini', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prompt: promptText,
                            apiKey,
                            model: geminiModel
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error:', errorText);
                        throw new Error('API request failed: ' + response.status);
                    }
                    const data = await response.json();
                    videoPrompt = data.response;
                }

                console.log('Received video prompt:', videoPrompt ? videoPrompt.substring(0, 100) + '...' : 'EMPTY');

                // 表示
                const displayDiv = document.getElementById('videoPromptDisplay');
                displayDiv.textContent = videoPrompt;
                displayDiv.style.display = 'block';

                document.getElementById('copyVideoBtn').style.display = 'block';

                btn.textContent = '✅ プロンプト生成完了！';
                setTimeout(() => {
                    btn.textContent = '🎬 MV用プロンプト生成（要テーマ＆API接続）';
                    btn.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('Video prompt generation error:', error);
                alert('プロンプト生成に失敗しました: ' + error.message);
                btn.textContent = '🎬 MV用プロンプト生成（要テーマ＆API接続）';
                btn.disabled = false;
            }
        }

        // プロンプトをクリップボードにコピー
        function copyVideoPrompt() {
            const promptText = document.getElementById('videoPromptDisplay').textContent;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(promptText).then(() => {
                    const btn = document.getElementById('copyVideoBtn');
                    const originalText = btn.textContent;
                    btn.textContent = '✅ コピー完了！';
                    setTimeout(() => {
                        btn.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    fallbackCopy(promptText);
                });
            } else {
                fallbackCopy(promptText);
            }
        }

        // フォールバック用コピー関数
        function fallbackCopy(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                alert('プロンプトをコピーしました！');
            } catch (err) {
                alert('コピーに失敗しました。手動でコピーしてください。');
            }

            document.body.removeChild(textArea);
        }

        // 既存のgenerateAITheme関数にビデオプロンプトボタン有効化を追加
        // 元の関数の最後でvideoPromptBtnを有効化するように修正済み
    </script>
</body>
</html>