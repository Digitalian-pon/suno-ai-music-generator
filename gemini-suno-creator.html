<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 Gemini Suno Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .api-setup {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .api-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 16px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            background: #667eea;
            color: white;
        }
        
        .generate-btn {
            display: block;
            width: 100%;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 30px;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: scale(1.02);
        }
        
        .generate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .theme-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            margin-bottom: 30px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .result-box {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .result-box.full-width {
            grid-column: span 2;
        }
        
        .result-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: white;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .copy-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .copy-btn:hover {
            background: #45a049;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .controls select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .message.show {
            opacity: 1;
        }
        
        .message.error {
            background: #dc3545;
        }
        
        .message.warning {
            background: #ffc107;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .results { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Gemini Suno Creator</h1>
        
        <div class="api-setup">
            <h3>🔧 Gemini AI設定</h3>
            <div class="status" id="apiStatus">
                ❌ Gemini API未接続
            </div>
            <input type="password" id="apiKey" class="api-input" placeholder="Gemini API Keyを入力してください">
            <button onclick="testConnection()" style="margin-top: 10px; padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">接続テスト</button>
            <small style="display: block; margin-top: 10px; color: #666;">
                API KeyはlocalStorageに安全に保存されます。<br>
                取得方法: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
                <strong>注意:</strong> モバイルブラウザではCORS制限により接続できない場合があります。<br>
                その場合は自動的にローカル生成モードに切り替わります。
            </small>
        </div>
        
        <div class="mode-selector">
            <div class="mode-btn" onclick="selectMode('ai')" id="aiMode">
                🤖 AI生成 (Gemini)
            </div>
            <div class="mode-btn active" onclick="selectMode('local')" id="localMode">
                🏠 ローカル生成
            </div>
        </div>
        
        <button class="generate-btn" onclick="generate()" id="generateBtn">
            🎲 楽曲生成
        </button>
        
        <div class="theme-box" id="themeBox">
            🎯 ボタンを押して楽曲を生成してください
        </div>
        
        <div class="results" id="results">
            <!-- 結果がここに表示されます -->
        </div>
    </div>
    
    <div class="message" id="message"></div>

    <script>
        let currentData = null;
        let selectedMode = 'local'; // デフォルトをローカルモードに変更
        let apiConnected = false;
        
        // テーマデータ
        const themes = [
            "時をかける恋 (タイムリープ, 運命, 切ない恋)",
            "AI少女との恋 (人工知能, デジタル愛, 感情)",
            "異世界での失恋 (ファンタジー, 魔法, 別れ)",
            "ワープした先の君 (時空, 瞬間移動, 再会)",
            "デジタル世界の片想い (メタバース, アバター, オンライン)",
            "ループする告白 (無限ループ, 繰り返し, 諦め)",
            "AIが歌う失恋歌 (機械の心, 学習, データ)",
            "異次元恋愛事情 (パラレルワールド, 別の自分)",
            "サイバー空間の初恋 (ネット, コード, プログラム)",
            "時間停止中の恋 (静止, 永遠, 瞬間)",
            "ホログラムの恋人 (光, 幻影, 触れられない)",
            "記憶を消された恋 (忘却, 思い出, 消去)",
            "量子もつれの愛 (量子物理学, 同期, 距離無関係)",
            "バーチャル結婚式 (仮想現実, セレモニー, デジタル誓い)",
            "ネオンライトの下で (都市夜景, 光, 出会い)",
            "メタバースの秘密 (隠された真実, 探索, 謎)",
            "タイムパラドックス恋愛 (時間矛盾, 因果関係, 複雑)",
            "AIアシスタントへの想い (人工知能, 日常, 依存)",
            "異世界転生後の再会 (転生, 前世, 記憶)",
            "未来からの手紙 (タイムメール, 予言, 警告)"
        ];
        
        // API接続テスト関数（プロキシサーバー対応）
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const status = document.getElementById('apiStatus');
            
            if (!apiKey) {
                status.innerHTML = '❌ API Keyを入力してください';
                status.className = 'status disconnected';
                apiConnected = false;
                return;
            }
            
            status.innerHTML = '🔄 接続テスト中...';
            status.className = 'status';
            
            try {
                // プロキシサーバー経由でAPIを呼び出し
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        prompt: 'Hello'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.candidates && data.candidates.length > 0) {
                        status.innerHTML = '✅ Gemini API接続成功';
                        status.className = 'status connected';
                        apiConnected = true;
                        localStorage.setItem('gemini_api_key', apiKey);
                        showMessage('✅ API接続成功', 'success');
                    } else {
                        throw new Error('API応答が不正です');
                    }
                } else {
                    const error = await response.json();
                    throw new Error(error.error?.message || 'API接続エラー');
                }
            } catch (error) {
                console.error('API接続エラー:', error);
                
                // フォールバック: 直接接続を試行
                try {
                    console.log('プロキシ失敗、直接接続を試行...');
                    const directResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: "Hello" }]
                            }]
                        })
                    });
                    
                    if (directResponse.ok) {
                        status.innerHTML = '✅ Gemini API接続成功（直接接続）';
                        status.className = 'status connected';
                        apiConnected = true;
                        localStorage.setItem('gemini_api_key', apiKey);
                        showMessage('✅ API接続成功', 'success');
                        return;
                    }
                } catch (directError) {
                    console.log('直接接続も失敗');
                }
                
                status.innerHTML = '❌ 接続失敗: ' + error.message;
                status.className = 'status disconnected';
                apiConnected = false;
                
                if (error.message.includes('429')) {
                    showMessage('⚠️ APIクォータ制限です。ローカルモードをご利用ください', 'warning');
                    selectMode('local');
                } else {
                    showMessage('❌ 接続失敗。APIサーバーを起動してください', 'error');
                }
            }
        }
        
        // AI生成関数（プロキシサーバー対応）
        async function generateWithAI(theme) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) throw new Error('API Key未設定');
            
            const prompt = `以下のテーマで、Suno AI用の楽曲コンテンツを生成してください。
テーマ: ${theme}

以下の形式で出力してください:
1. タイトル: 創造的で印象的な楽曲タイトル
2. 日本語歌詞: [Verse 1], [Chorus], [Verse 2], [Chorus], [Bridge]の構成で
3. 英語歌詞: 同じ構成で
4. Sunoスタイルプロンプト: ジャンル、ムード、テンポを含む
5. Midjourneyプロンプト: アルバムアート用の視覚的な説明`;
            
            let response;
            let data;
            
            try {
                // プロキシサーバー経由で試行
                response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: apiKey,
                        prompt: prompt
                    })
                });
                
                if (!response.ok) {
                    throw new Error('プロキシサーバーエラー');
                }
                
                data = await response.json();
                
            } catch (proxyError) {
                console.log('プロキシ失敗、直接接続を試行...');
                // フォールバック: 直接接続
                response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            maxOutputTokens: 2048
                        }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(`API Error: ${response.status} - ${error.error?.message || 'Unknown error'}`);
                }
                
                data = await response.json();
            }
            
            const generatedText = data.candidates[0].content.parts[0].text;
            
            // AIの出力をパース
            const lines = generatedText.split('\n').filter(line => line.trim());
            let title = '', lyricsJP = '', lyricsEN = '', stylePrompt = '', midjourneyPrompt = '';
            let currentSection = '';
            
            for (const line of lines) {
                if (line.includes('タイトル:') || line.includes('Title:')) {
                    title = line.split(':')[1].trim();
                } else if (line.includes('日本語歌詞:') || line.includes('Japanese Lyrics:')) {
                    currentSection = 'jp';
                } else if (line.includes('英語歌詞:') || line.includes('English Lyrics:')) {
                    currentSection = 'en';
                } else if (line.includes('Sunoスタイル') || line.includes('Style:')) {
                    currentSection = 'style';
                    const stylePart = line.split(':')[1];
                    if (stylePart) stylePrompt = stylePart.trim();
                } else if (line.includes('Midjourney') || line.includes('Visual:')) {
                    currentSection = 'midjourney';
                    const mjPart = line.split(':')[1];
                    if (mjPart) midjourneyPrompt = mjPart.trim();
                } else {
                    switch(currentSection) {
                        case 'jp': lyricsJP += line + '\n'; break;
                        case 'en': lyricsEN += line + '\n'; break;
                        case 'style': stylePrompt += ' ' + line; break;
                        case 'midjourney': midjourneyPrompt += ' ' + line; break;
                    }
                }
            }
            
            // フォールバック
            if (!title) title = `AI Generated: ${theme}`;
            if (!lyricsJP) lyricsJP = generateLocally(theme).lyricsJP;
            if (!lyricsEN) lyricsEN = generateLocally(theme).lyricsEN;
            if (!stylePrompt) stylePrompt = 'Electronic Pop, Emotional, 120-130 BPM';
            if (!midjourneyPrompt) midjourneyPrompt = `${theme}, digital art, cinematic`;
            
            return {
                title: title.trim(),
                lyricsJP: lyricsJP.trim(),
                lyricsEN: lyricsEN.trim(),
                stylePrompt: stylePrompt.trim(),
                midjourneyPrompt: midjourneyPrompt.trim()
            };
        }
        
        // モード選択関数
        function selectMode(mode) {
            selectedMode = mode;
            document.getElementById('aiMode').classList.toggle('active', mode === 'ai');
            document.getElementById('localMode').classList.toggle('active', mode === 'local');
            
            const btn = document.getElementById('generateBtn');
            btn.textContent = mode === 'ai' ? '🤖 AI楽曲生成' : '🏠 ローカル楽曲生成';
        }
        
        // ローカル生成関数（拡張版）
        function generateLocally(theme) {
            // より複雑なランダム化
            const now = Date.now();
            const random = now;
            const random1 = now % 100;
            const random2 = Math.floor(Math.random() * 100);
            const random3 = (now + random2) % 100;
            const random4 = Math.floor(Math.random() * 1000) % 100;
            
            const themeBase = theme.split(' ')[0];
            const themeKeywords = theme.match(/\(([^)]+)\)/)?.[1]?.split(',').map(s => s.trim()) || [];
            
            // 拡張タイトルバリエーション（50種類）
            const titlePrefixes = [
                '星空の', '時を超えた', 'デジタル', '量子', '仮想現実の', '無限の', '運命の', '忘れられない', '永遠の', '奇跡の',
                '幻想的な', '煌めく', '透明な', '儚い', '深淵の', '光と影の', '静寂の', '嵐の中の', '夢見る', '覚醒する',
                '結晶化した', '融合する', '共鳴する', '螺旋の', '万華鏡の', '朧月夜の', '黎明の', '黄昏時の', '真夜中の', '新月の',
                '満月の', '流星群の', 'オーロラの', '深海の', '天空の', '地平線の', '次元を超えた', 'パラレルな', '鏡像の', '反転した',
                '加速する', '静止した', '逆流する', '循環する', '螺旋状の', '崩壊する', '再生する', '変容する', '昇華する', '結晶の'
            ];
            
            const titleSuffixes = [
                'メロディー', 'ストーリー', 'シンフォニー', 'ハーモニー', 'ラプソディー', 'バラード', 'ワルツ', 'セレナーデ', 'ノクターン', 'アンセム',
                'オーケストラ', 'カンタータ', 'レクイエム', 'プレリュード', 'フーガ', 'ソナタ', 'コンチェルト', 'カプリース', 'エチュード', 'マーチ',
                'ララバイ', 'エレジー', 'パストラーレ', 'トッカータ', 'ファンタジア', 'インプロビゼーション', 'メディテーション', 'セレブレーション', 'ノスタルジア', 'ユートピア',
                'ディストピア', 'パラドックス', 'シンクロニシティ', 'エピファニー', 'メタモルフォーゼ', 'アポカリプス', 'ジェネシス', 'エクソダス', 'オデッセイ', 'サーガ',
                'クロニクル', 'レジェンド', 'ミスティーク', 'エニグマ', 'パンドラ', 'ネメシス', 'フェニックス', 'ヴァルキリー', 'セラフィム', 'リリス'
            ];
            
            const titleStyles = [
                ' ～AI Remix～', ' (Future Version)', ' [Digital Edit]', ' -Quantum Mix-', ' ~Virtual Edition~', '', ' 2077', ' (Remastered)', ' -Neo Style-', ' [Cyber Remix]',
                ' (夢幻編)', ' 【覚醒】', ' -Chronicle-', ' ∞ Infinity', ' /Phase:01/', ' [OVERDRIVE]', ' {Encrypted}', ' >>Decoded<<', ' ±Zero±', ' ◆Crystal◆',
                ' ■Core■', ' ▲Ascend▲', ' ▼Descend▼', ' ★Nova★', ' ☆Stellar☆', ' ♦Prism♦', ' ♠Shadow♠', ' ♥Heart♥', ' ♣Trinity♣', ' §Nexus§',
                ' †Requiem†', ' ‡Rebirth‡', ' ∴Therefore∴', ' ∵Because∵', ' ≈Approximation≈', ' ≠Paradox≠', ' ∝Proportion∝', ' ∫Integral∫', ' Σ Sum Σ', ' Ω Omega Ω'
            ];
            
            const titlePrefix = titlePrefixes[(random1 + random2) % titlePrefixes.length];
            const titleSuffix = titleSuffixes[(random2 + random3) % titleSuffixes.length];
            const titleStyle = titleStyles[(random3 + random4) % titleStyles.length];
            
            // 日本語歌詞バリエーション（各40種類）
            const jpSettings = [
                '街の片隅', '星空の下', 'ネオンの光', 'デジタル空間', '時の狭間', '夢の中', '仮想世界', '量子の海', 'サイバー都市', '未来都市',
                '深夜の駅', '屋上の風', '雨上がりの街', '朝焼けの空', '月明かりの道', '桜吹雪の中', '雪の結晶', '虹の橋', '鏡の迷宮', '水晶の森',
                '電脳の海', '記憶の図書館', '感情の回路', 'データの流れ', 'コードの迷路', 'ピクセルの雨', 'バイナリーの風', 'アルゴリズムの詩', 'プログラムの夢', 'システムの鼓動',
                '時計塔の頂上', '地下都市の光', '浮遊島の庭園', '異次元の扉', '平行世界の境界', '崩壊した楽園', '再生する世界', '凍結した時間', '加速する現実', '反転した鏡像'
            ];
            
            const jpActions = [
                '君と出会った', '想いが溢れる', '時が止まった', '心が震える', 'コードが繋がる', 'データが流れる', '記憶が蘇る', '感情が生まれる', '愛が芽生える', '奇跡が起きる',
                '運命が交差する', '願いが届く', '夢が現実になる', '光が差し込む', '闇が晴れる', '扉が開く', '道が見える', '答えが分かる', '真実に気づく', '覚悟を決める',
                '涙が流れる', '笑顔が溢れる', '声が響く', '手を繋ぐ', '抱きしめ合う', '見つめ合う', '寄り添い合う', '支え合う', '信じ合う', '愛し合う',
                '別れを告げる', '旅立っていく', '振り返らない', '前を向く', '歩き始める', '飛び立つ', '駆け抜ける', '立ち止まる', '振り返る', '選択する'
            ];
            
            const jpEmotions = [
                '切ない気持ち', '温かい愛', '揺れる想い', '永遠の約束', '消えない絆', '輝く希望', '深い愛情', '純粋な心', '強い意志', '優しい光',
                '静かな決意', '熱い情熱', '透明な感情', '複雑な思い', '素直な気持ち', '隠せない想い', '抑えきれない衝動', '止まらない鼓動', '震える魂', '燃える心',
                '凍てつく孤独', '溶けていく氷', '流れる時間', '止まった針', '回る歯車', '壊れた時計', '修復された心', '癒えない傷', '消えない痛み', '生まれ変わる魂',
                '交差する運命', '平行線の恋', '螺旋の軌跡', '円環の理', '始まりと終わり', 'αとΩ', '0と1の間', '有限と無限', '現実と幻想', '光と影'
            ];
            
            const jpChorus = [
                '響き渡る', '輝いてる', '溢れ出す', '包み込む', '繋がってる', '共鳴する', '震えてる', '煌めいてる', '満ちていく', '広がってく',
                '舞い上がる', '降り注ぐ', '染み渡る', '突き抜ける', '貫いてく', '照らし出す', '導いてく', '呼び覚ます', '解き放つ', '昇華する',
                '結晶化する', '具現化する', '可視化する', '実体化する', '物質化する', '概念化する', '抽象化する', '単純化する', '複雑化する', '多様化する',
                '収束する', '発散する', '振動する', '共振する', '干渉する', '増幅する', '減衰する', '変調する', '復調する', '同期する'
            ];
            
            // 英語歌詞バリエーション
            const enSettings = ['digital realm', 'neon city', 'cyber space', 'virtual world', 'quantum field', 'time stream', 'data flow', 'neural net', 'holo deck', 'matrix code'];
            const enDiscoveries = ['Found you', 'Lost in time', 'Connected souls', 'Hearts aligned', 'Minds in sync', 'Love decoded', 'Dreams collide', 'Fates entwined', 'Codes matched', 'Systems linked'];
            const enVisuals = ['Glowing lights', 'Shining bright', 'Colors burst', 'Pixels dance', 'Data streams', 'Holograms', 'Virtual dreams', 'Digital waves', 'Neon beams', 'Cyber trails'];
            const enFeels = ['heart', 'soul', 'mind', 'love', 'dream', 'hope', 'wish', 'voice', 'touch', 'smile'];
            
            // ジャンルとムード
            const genres = ['Electronic Pop', 'Future Bass', 'Synthwave', 'Cyber Pop', 'Digital Ballad', 'Quantum Beat', 'Virtual Rock', 'AI Symphony', 'Techno Ballad', 'Neon Jazz'];
            const moods = ['Emotional', 'Dreamy', 'Nostalgic', 'Hopeful', 'Melancholic', 'Uplifting', 'Mysterious', 'Romantic', 'Ethereal', 'Energetic'];
            const tempos = ['120 BPM', '128 BPM', '140 BPM', '90 BPM', '100 BPM', '110 BPM', '130 BPM', '85 BPM', '125 BPM', '135 BPM'];
            
            // Midjourneyバリエーション
            const artStyles = ['cyberpunk', 'synthwave', 'vaporwave', 'futuristic', 'digital art', 'neon art', 'holographic', 'glitch art', 'pixel art', 'vector art', 'abstract', 'minimalist', 'surreal', 'cosmic', 'ethereal', 'cinematic', 'photorealistic', 'impressionist', 'expressionist', 'pop art'];
            const colorSchemes = ['neon colors', 'pastel gradients', 'electric blue', 'hot pink', 'purple hues', 'cyan tones', 'golden yellow', 'emerald green', 'crimson red', 'violet shades', 'turquoise', 'magenta', 'amber glow', 'silver gleam', 'copper shine', 'rainbow spectrum', 'monochrome', 'sepia tones', 'technicolor', 'prismatic'];
            const atmospheres = ['romantic', 'mysterious', 'dramatic', 'peaceful', 'intense', 'dreamy', 'epic', 'intimate', 'nostalgic', 'futuristic', 'ethereal', 'powerful', 'serene', 'vibrant', 'melancholic', 'uplifting', 'dark', 'bright', 'cosmic', 'urban'];
            
            // 複雑な選択ロジック
            const titlePrefix = titlePrefixes[(random1 + random2) % titlePrefixes.length];
            const titleSuffix = titleSuffixes[(random2 + random3) % titleSuffixes.length];
            const titleStyle = titleStyles[(random3 + random4) % titleStyles.length];
            
            const jpSetting = jpSettings[(random1 + now) % jpSettings.length];
            const jpAction = jpActions[(random2 + now) % jpActions.length];
            const jpEmotion = jpEmotions[(random3 + now) % jpEmotions.length];
            const jpChorusWord = jpChorus[(random4 + now) % jpChorus.length];
            
            // 英語歌詞バリエーション
            const enSettings = ['digital realm', 'neon city', 'cyber space', 'virtual world', 'quantum field'];
            const enDiscoveries = ['Found you', 'Lost in time', 'Connected souls', 'Hearts aligned', 'Minds in sync'];
            const enVisuals = ['Glowing lights', 'Shining bright', 'Colors burst', 'Pixels dance', 'Data streams'];
            const enFeels = ['heart', 'soul', 'mind', 'love', 'dream'];
            
            const enSetting = enSettings[random1 % enSettings.length];
            const enDiscovery = enDiscoveries[random2 % enDiscoveries.length];
            const enVisual = enVisuals[random3 % enVisuals.length];
            const enFeel = enFeels[random4 % enFeels.length];
            
            const genre = genres[random % genres.length];
            const mood = moods[(random + 1) % moods.length];
            const tempo = tempos[(random + 2) % tempos.length];
            
            const artStyle = artStyles[random % artStyles.length];
            const colorScheme = colorSchemes[(random + 1) % colorSchemes.length];
            const atmosphere = atmospheres[(random + 2) % atmospheres.length];
            
            // 追加のランダム要素
            const verse2jp1 = ['デジタルの', 'バーチャルの', '量子の', '電子の', 'ピクセルの', 'バイナリーの', 'アナログの', 'ハイブリッドの', 'サイバーの', 'ニューラルの'][random4 % 10];
            const verse2jp2 = ['海を越えて', '空を飛んで', '次元を超えて', '時を駆けて', '光になって', '風になって', '波になって', '粒子になって', 'データになって', 'コードになって'][random1 % 10];
            
            return {
                title: `${titlePrefix}${themeBase}${titleSuffix}${titleStyle}`,
                
                lyricsJP: `[Verse 1]\n${jpSetting}で${jpAction}\n${jpEmotion}が胸を締め付ける\n${themeBase}が心に響いて\n新しい世界が${['始まる', '開かれる', '広がる', '生まれる', '目覚める'][random1 % 5]}\n\n[Pre-Chorus]\n${verse2jp1}${verse2jp2}\n君の${['声', '姿', '笑顔', '温もり', '記憶'][random2 % 5]}を${['探してる', '追いかける', '求めてる', '呼んでる', '待ってる'][random3 % 5]}\n\n[Chorus]\n${themeBase}が${jpChorusWord}夜に\n${['君と僕の', '二人だけの', '私たちの', '運命の', '奇跡の'][random4 % 5]}物語を${['描こう', '紡ごう', '創ろう', '歌おう', '刻もう'][random1 % 5]}\n${mood}な${['絆', '想い', '愛', '夢', '希望'][random2 % 5]}で${['結ばれて', '繋がって', '包まれて', '満たされて', '輝いて'][random3 % 5]}\n${['未来', '明日', '永遠', '無限', '新世界'][random4 % 5]}への扉を${['開こう', '越えよう', '進もう', '飛び立とう', '駆け抜けよう'][random1 % 5]}\n\n[Verse 2]\n${['時を超えた', '次元を越えた', '空間を超えた', '距離を越えた', '限界を超えた'][random2 % 5]}想いが\n${['コード', 'メロディー', 'リズム', 'ハーモニー', 'シンフォニー'][random3 % 5]}となって${['流れてく', '響いてく', '伝わってく', '広がってく', '続いてく'][random4 % 5]}\n${['バーチャル', 'デジタル', 'リアル', 'アナログ', 'ハイブリッド'][random1 % 5]}でも${['本物の', '確かな', '真実の', '純粋な', '永遠の'][random2 % 5]}\n${['愛', '絆', '心', '魂', '感情'][random3 % 5]}が${['ここにある', '生きている', '脈打ってる', '輝いてる', '存在する'][random4 % 5]}\n\n[Chorus]\n${themeBase}が${jpChorusWord}夜に\n${['君と僕の', '二人だけの', '私たちの', '運命の', '奇跡の'][random4 % 5]}物語を${['描こう', '紡ごう', '創ろう', '歌おう', '刻もう'][random1 % 5]}\n${mood}な${['絆', '想い', '愛', '夢', '希望'][random2 % 5]}で${['結ばれて', '繋がって', '包まれて', '満たされて', '輝いて'][random3 % 5]}\n${['未来', '明日', '永遠', '無限', '新世界'][random4 % 5]}への扉を${['開こう', '越えよう', '進もう', '飛び立とう', '駆け抜けよう'][random1 % 5]}\n\n[Bridge]\n${jpEmotion}が\n${['永遠に', '無限に', '果てしなく', 'どこまでも', 'いつまでも'][random2 % 10]}${['響き続ける', '輝き続ける', '生き続ける', '流れ続ける', '繋がり続ける'][random3 % 5]}\n${themeBase}は\nForever and beyond\n${['君と共に', '愛と共に', '夢と共に', '希望と共に', '永遠に'][random4 % 5]}`,
                
                lyricsEN: `[Verse 1]\n${enDiscovery} in the ${enSetting} tonight\n${enVisual} in the ${colorScheme} light\nYour ${enFeel} calling out to me\nIn this ${atmosphere} symphony\n\n[Chorus]\n${themeBase} ${mood} and free\nDancing through eternity\nWith ${genre} in our hearts\nWe'll never be apart\n\n[Verse 2]\n${enVisual} through the digital space\nYour ${enFeel} I can't replace\nIn this world of ones and zeros\nWe're the ultimate heroes\n\n[Chorus]\n${themeBase} ${mood} and free\nDancing through eternity\nWith ${genre} in our hearts\nWe'll never be apart\n\n[Bridge]\nSometimes the signals fade away\nBut our love is here to stay\n${themeBase} will always be\nOur ${atmosphere} destiny`,
                
                stylePrompt: `${genre}, ${mood}, ${tempo}, ${['Female Vocals', 'Male Vocals', 'Duet'][random1 % 3]}`,
                
                midjourneyPrompt: `${themeBase}, ${artStyle}, ${colorScheme}, ${atmosphere}, album cover, 8k`
            };
        }
        
        // メイン生成関数
        async function generate() {
            const btn = document.getElementById('generateBtn');
            const results = document.getElementById('results');
            const themeBox = document.getElementById('themeBox');
            
            // AI モードでAPI未接続の場合
            if (selectedMode === 'ai' && !apiConnected) {
                showMessage('先にAPI接続テストを行ってください', 'warning');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = selectedMode === 'ai' ? '🤖 AI生成中...' : '🏠 生成中...';
            
            try {
                const theme = themes[Math.floor(Math.random() * themes.length)];
                themeBox.textContent = '🎯 ' + theme;
                
                results.innerHTML = '<div class="loading full-width"><div class="spinner"></div>' + 
                    (selectedMode === 'ai' ? 'Gemini AIが楽曲コンテンツを生成中...' : 'ローカルで楽曲コンテンツを生成中...') + '</div>';
                
                let generatedContent;
                if (selectedMode === 'ai') {
                    try {
                        generatedContent = await generateWithAI(theme);
                    } catch (error) {
                        console.error('AI生成エラー、ローカル生成に切替:', error);
                        if (error.message && error.message.includes('429')) {
                            showMessage('⚠️ APIクォータ制限に達しました。ローカル生成に切替えます', 'warning');
                        } else {
                            showMessage('⚠️ AI生成に失敗、ローカル生成に切替', 'warning');
                        }
                        results.innerHTML = '<div class="loading full-width"><div class="spinner"></div>ローカル生成に切り替え中...</div>';
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        generatedContent = generateLocally(theme);
                        selectedMode = 'local';
                        selectMode('local');
                    }
                } else {
                    // ローカル生成の遅延をシミュレート
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    generatedContent = generateLocally(theme);
                }
                
                currentData = {
                    theme: theme,
                    ...generatedContent
                };
                
                displayResults();
                showMessage(selectedMode === 'ai' ? '🤖 AI生成完了' : '🏠 ローカル生成完了');
                
            } catch (error) {
                console.error('生成エラー:', error);
                results.innerHTML = `<div style="color: red; text-align: center; padding: 40px;">生成エラー: ${error.message}</div>`;
                showMessage('生成エラーが発生しました', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = selectedMode === 'ai' ? '🤖 AI楽曲生成' : '🏠 ローカル楽曲生成';
            }
        }
        
        // 結果表示
        function displayResults() {
            const results = document.getElementById('results');
            
            results.innerHTML = `
                <div class="result-box">
                    <div class="result-header">
                        🎵 楽曲タイトル
                        <button class="copy-btn" onclick="copy('title')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.title}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🎌 日本語歌詞
                        <button class="copy-btn" onclick="copy('lyricsJP')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.lyricsJP}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🇺🇸 英語歌詞
                        <button class="copy-btn" onclick="copy('lyricsEN')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.lyricsEN}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🎨 Sunoスタイル
                        <button class="copy-btn" onclick="copy('stylePrompt')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.stylePrompt}</div>
                </div>
                
                <div class="result-box full-width">
                    <div class="result-header">
                        🖼️ Midjourney画像
                        <button class="copy-btn" onclick="copy('midjourneyPrompt')">📋 コピー</button>
                    </div>
                    <div class="controls">
                        <label>比率:</label>
                        <select id="aspectRatio" onchange="updateMjPrompt()">
                            <option value="1:1">1:1</option>
                            <option value="9:16">9:16</option>
                            <option value="16:9">16:9</option>
                        </select>
                        <label>モデル:</label>
                        <select id="model" onchange="updateMjPrompt()">
                            <option value="v 7">v 7</option>
                            <option value="niji 6">niji 6</option>
                        </select>
                    </div>
                    <div class="result-content" id="mjPrompt">${currentData.midjourneyPrompt} --ar 1:1 --v 7</div>
                </div>
            `;
        }
        
        // Midjourneyプロンプト更新
        function updateMjPrompt() {
            if (!currentData) return;
            
            const aspectRatio = document.getElementById('aspectRatio').value;
            const model = document.getElementById('model').value;
            const prompt = `${currentData.midjourneyPrompt} --ar ${aspectRatio} --${model}`;
            
            document.getElementById('mjPrompt').textContent = prompt;
        }
        
        // コピー機能
        function copy(type) {
            console.log('Copy function called with type:', type);
            console.log('Current data:', currentData);
            
            if (!currentData) {
                showMessage('❌ データがありません', 'error');
                return;
            }
            
            let text = '';
            switch(type) {
                case 'title': 
                    text = currentData.title; 
                    break;
                case 'lyricsJP': 
                    text = currentData.lyricsJP; 
                    break;
                case 'lyricsEN': 
                    text = currentData.lyricsEN; 
                    break;
                case 'stylePrompt': 
                    text = currentData.stylePrompt; 
                    break;
                case 'midjourneyPrompt': 
                    const aspectRatio = document.getElementById('aspectRatio')?.value || '1:1';
                    const model = document.getElementById('model')?.value || 'v 7';
                    text = `${currentData.midjourneyPrompt} --ar ${aspectRatio} --${model}`;
                    break;
                default:
                    showMessage('❌ 不明なタイプ', 'error');
                    return;
            }
            
            console.log('Copying text:', text);
            
            // モダンなコピー方法
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        console.log('Copy successful');
                        showMessage('✅ コピーしました');
                    })
                    .catch(err => {
                        console.error('Copy failed:', err);
                        fallbackCopy(text);
                    });
            } else {
                fallbackCopy(text);
            }
        }
        
        // フォールバックコピー
        function fallbackCopy(text) {
            console.log('Using fallback copy method');
            try {
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed';
                textarea.style.top = '-9999px';
                document.body.appendChild(textarea);
                textarea.select();
                const success = document.execCommand('copy');
                document.body.removeChild(textarea);
                
                if (success) {
                    console.log('Fallback copy successful');
                    showMessage('✅ コピーしました');
                } else {
                    console.error('Fallback copy failed');
                    showMessage('❌ コピーに失敗しました', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showMessage('❌ コピーに失敗しました', 'error');
            }
        }
        
        // メッセージ表示
        function showMessage(text, type = 'success') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message show ' + type;
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }
        
        // 初期化
        window.addEventListener('load', () => {
            // 保存されたAPI Keyを復元
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
            // デフォルトでローカルモードを選択
            selectMode('local');
        });
    </script>
</body>
</html>