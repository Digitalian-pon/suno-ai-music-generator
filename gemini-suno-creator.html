<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎵 Gemini Suno Creator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .api-setup {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .api-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 16px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            border-radius: 25px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mode-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .generate-btn {
            display: block;
            width: 300px;
            margin: 0 auto 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .generate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        
        .generate-btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        .theme-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #495057;
        }
        
        .results {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .result-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-weight: bold;
            color: #667eea;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .result-content {
            background: white;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .controls select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .message.show {
            opacity: 1;
        }
        
        .message.error {
            background: #dc3545;
        }
        
        .message.warning {
            background: #ffc107;
            color: #333;
        }
        
        @media (max-width: 768px) {
            .results { grid-template-columns: 1fr; }
            h1 { font-size: 2em; }
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Gemini Suno Creator</h1>
        
        <div class="api-setup">
            <h3>🔧 Gemini AI設定</h3>
            <div class="status" id="apiStatus">
                ❌ Gemini API未接続
            </div>
            <input type="password" id="apiKey" class="api-input" placeholder="Gemini API Keyを入力してください">
            <button onclick="testConnection()" style="margin-top: 10px; padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer;">接続テスト</button>
            <small style="display: block; margin-top: 10px; color: #666;">
                API KeyはlocalStorageに安全に保存されます。<br>
                取得方法: <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
                <strong>注意:</strong> モバイルブラウザではCORS制限により接続できない場合があります。<br>
                その場合は自動的にローカル生成モードに切り替わります。
            </small>
        </div>
        
        <div class="mode-selector">
            <div class="mode-btn active" onclick="selectMode('ai')" id="aiMode">
                🤖 AI生成 (Gemini)
            </div>
            <div class="mode-btn" onclick="selectMode('local')" id="localMode">
                🏠 ローカル生成
            </div>
        </div>
        
        <button class="generate-btn" onclick="generate()" id="generateBtn">
            🎲 楽曲生成
        </button>
        
        <div class="theme-box" id="themeBox">
            🎯 ボタンを押して楽曲を生成してください
        </div>
        
        <div class="results" id="results">
            <!-- 結果がここに表示されます -->
        </div>
    </div>
    
    <div class="message" id="message"></div>

    <script>
        let currentData = null;
        let selectedMode = 'ai';
        let apiConnected = false;
        
        // テーマデータ
        const themes = [
            "時をかける恋 (タイムリープ, 運命, 切ない恋)",
            "AI少女との恋 (人工知能, デジタル愛, 感情)",
            "異世界での失恋 (ファンタジー, 魔法, 別れ)",
            "ワープした先の君 (時空, 瞬間移動, 再会)",
            "デジタル世界の片想い (メタバース, アバター, オンライン)",
            "ループする告白 (無限ループ, 繰り返し, 諦め)",
            "AIが歌う失恋歌 (機械の心, 学習, データ)",
            "異次元恋愛事情 (パラレルワールド, 別の自分)",
            "サイバー空間の初恋 (ネット, コード, プログラム)",
            "時間停止中の恋 (静止, 永遠, 瞬間)",
            "ホログラムの恋人 (光, 幻影, 触れられない)",
            "記憶を消された恋 (忘却, 思い出, 消去)",
            "量子もつれの愛 (量子物理学, 同期, 距離無関係)",
            "バーチャル結婚式 (仮想現実, セレモニー, デジタル誓い)",
            "ネオンライトの下で (都市夜景, 光, 出会い)",
            "メタバースの秘密 (隠された真実, 探索, 謎)",
            "タイムパラドックス恋愛 (時間矛盾, 因果関係, 複雑)",
            "AIアシスタントへの想い (人工知能, 日常, 依存)",
            "異世界転生後の再会 (転生, 前世, 記憶)",
            "未来からの手紙 (タイムメール, 予言, 警告)"
        ];
        
        // モード選択
        function selectMode(mode) {
            selectedMode = mode;
            document.getElementById('aiMode').classList.toggle('active', mode === 'ai');
            document.getElementById('localMode').classList.toggle('active', mode === 'local');
            
            const btn = document.getElementById('generateBtn');
            if (mode === 'ai') {
                btn.textContent = apiConnected ? '🤖 AI楽曲生成' : '🔧 API接続が必要';
                btn.disabled = !apiConnected;
            } else {
                btn.textContent = '🏠 ローカル楽曲生成';
                btn.disabled = false;
            }
        }
        
        // Gemini Flash モデルのみ使用
        const workingModel = 'gemini-1.5-flash';
        
        // API接続テスト
        async function testConnection() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showMessage('API Keyを入力してください', 'error');
                return;
            }
            
            const status = document.getElementById('apiStatus');
            status.textContent = '🔄 Gemini-Flash接続テスト中...';
            status.className = 'status';
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${workingModel}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: 'Hello' }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 50,
                        }
                    })
                });
                
                const responseData = await response.json();
                console.log('Gemini Flash Response:', responseData);
                
                if (response.ok && responseData.candidates && responseData.candidates.length > 0) {
                    apiConnected = true;
                    localStorage.setItem('gemini_api_key', apiKey);
                    status.textContent = '✅ Gemini Flash 接続成功';
                    status.className = 'status connected';
                    showMessage('✅ Gemini Flash 接続成功', 'success');
                    selectMode('ai');
                } else {
                    throw new Error(`API Error: ${response.status} - ${responseData.error?.message || JSON.stringify(responseData)}`);
                }
            } catch (error) {
                console.error('API接続エラー:', error);
                apiConnected = false;
                status.textContent = '❌ 接続失敗';
                status.className = 'status disconnected';
                showMessage('❌ API接続失敗 - ローカルモードを使用してください', 'error');
                selectMode('local');
            }
        }
        
        // Gemini API呼び出し
        async function callGeminiAPI(prompt) {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                throw new Error('API Key not found');
            }
            
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${workingModel}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: 0.9,
                        maxOutputTokens: 1000,
                    }
                })
            });
            
            const data = await response.json();
            console.log('Gemini API Response:', data);
            
            if (!response.ok) {
                throw new Error(`API Error: ${response.status} - ${data.error?.message || 'Unknown error'}`);
            }
            
            if (!data.candidates || data.candidates.length === 0) {
                throw new Error('No response generated');
            }
            
            return data.candidates[0].content.parts[0].text;
        }
        
        // AI生成関数
        async function generateWithAI(theme) {
            // ランダム性を高めるためにタイムスタンプを追加
            const randomSeed = Date.now() % 10000;
            
            const prompts = {
                title: `Create a unique song title for "${theme}". Make it creative and different. Random seed: ${randomSeed}. Title only.`,
                
                lyricsJP: `Write original Japanese lyrics about "${theme}". Use creative expressions. Include [Verse 1], [Chorus], [Verse 2], [Chorus], [Bridge], [Final Chorus]. Avoid common phrases. Seed: ${randomSeed}. Lyrics only.`,
                
                lyricsEN: `Write original English lyrics about "${theme}". Be creative and unique. Include [Verse 1], [Chorus], [Verse 2], [Chorus], [Bridge], [Final Chorus]. Avoid repetitive phrases. Seed: ${randomSeed + 1}. Lyrics only.`,
                
                stylePrompt: `Short style for "${theme}": Genre, mood, tempo. 20 words max. Seed: ${randomSeed + 2}.`,
                
                midjourneyPrompt: `"${theme}" art: style, colors. 15 words max. Seed: ${randomSeed + 3}.`
            };
            
            const results = {};
            
            for (const [key, prompt] of Object.entries(prompts)) {
                try {
                    results[key] = await callGeminiAPI(prompt);
                    // 少し待機してレート制限を避ける
                    await new Promise(resolve => setTimeout(resolve, 1000));
                } catch (error) {
                    console.error(`${key}生成エラー:`, error);
                    results[key] = `生成エラー: ${error.message}`;
                }
            }
            
            return results;
        }
        
        // ローカル生成（フォールバック）
        function generateLocally(theme) {
            const themeBase = theme.split(' (')[0];
            
            return {
                title: `Digital ${themeBase} 2024`,
                lyricsJP: `[Verse 1]\nデジタルの世界で君を見つけた\n${themeBase}の物語が始まる\n心に響く想いを込めて\n永遠に続くこの愛を\n\n[Chorus]\n${themeBase}が輝く夜に\n君と僕の未来を描こう\nリアルを超えた絆で\n新しい世界へ歩いていこう\n\n[Verse 2]\nピクセルに込められた想い\nコードで歌う愛の歌\nバーチャルでも本物の\n気持ちがここにある\n\n[Chorus]\n${themeBase}が輝く夜に\n君と僕の未来を描こう\nリアルを超えた絆で\n新しい世界へ歩いていこう\n\n[Bridge]\n時を超えて響く愛\n永遠に続く物語\n${themeBase}は\nForever and always`,
                
                lyricsEN: `[Verse 1]\nFound you in the digital world tonight\n${themeBase} story begins to shine\nWith feelings deep inside my heart\nThis love will last for all time\n\n[Chorus]\nIn the night where ${themeBase} glows\nLet's paint our future, you and me\nWith bonds that transcend reality\nWe'll walk into a world so free\n\n[Verse 2]\nEmotions coded in every pixel\nLove songs written in digital code\nEven in virtual spaces\nThese feelings are real and true\n\n[Chorus]\nIn the night where ${themeBase} glows\nLet's paint our future, you and me\nWith bonds that transcend reality\nWe'll walk into a world so free\n\n[Bridge]\nLove that echoes across time\nA story that will never end\n${themeBase}\nForever and always`,
                
                stylePrompt: `Electronic Pop, emotional, 120 BPM`,
                
                midjourneyPrompt: `${themeBase}, neon, digital art`
            };
        }
        
        // メイン生成関数
        async function generate() {
            const btn = document.getElementById('generateBtn');
            const results = document.getElementById('results');
            const themeBox = document.getElementById('themeBox');
            
            // AI モードでAPI未接続の場合
            if (selectedMode === 'ai' && !apiConnected) {
                showMessage('先にAPI接続テストを行ってください', 'warning');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = selectedMode === 'ai' ? '🤖 AI生成中...' : '🏠 生成中...';
            
            try {
                const theme = themes[Math.floor(Math.random() * themes.length)];
                themeBox.textContent = '🎯 ' + theme;
                
                results.innerHTML = '<div class="loading full-width"><div class="spinner"></div>' + 
                    (selectedMode === 'ai' ? 'Gemini AIが楽曲コンテンツを生成中...' : 'ローカルで楽曲コンテンツを生成中...') + '</div>';
                
                let generatedContent;
                if (selectedMode === 'ai') {
                    try {
                        generatedContent = await generateWithAI(theme);
                    } catch (error) {
                        console.error('AI生成エラー、ローカル生成に切替:', error);
                        showMessage('⚠️ AI生成に失敗、ローカル生成に切替', 'warning');
                        results.innerHTML = '<div class="loading full-width"><div class="spinner"></div>ローカル生成に切り替え中...</div>';
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        generatedContent = generateLocally(theme);
                        selectedMode = 'local';
                        selectMode('local');
                    }
                } else {
                    // ローカル生成の遅延をシミュレート
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    generatedContent = generateLocally(theme);
                }
                
                currentData = {
                    theme: theme,
                    ...generatedContent
                };
                
                displayResults();
                showMessage(selectedMode === 'ai' ? '🤖 AI生成完了' : '🏠 ローカル生成完了');
                
            } catch (error) {
                console.error('生成エラー:', error);
                results.innerHTML = `<div style="color: red; text-align: center; padding: 40px;">生成エラー: ${error.message}</div>`;
                showMessage('生成エラーが発生しました', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = selectedMode === 'ai' ? '🤖 AI楽曲生成' : '🏠 ローカル楽曲生成';
            }
        }
        
        // 結果表示
        function displayResults() {
            const results = document.getElementById('results');
            
            results.innerHTML = `
                <div class="result-box">
                    <div class="result-header">
                        🎵 楽曲タイトル
                        <button class="copy-btn" onclick="copy('title')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.title}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🎌 日本語歌詞
                        <button class="copy-btn" onclick="copy('lyricsJP')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.lyricsJP}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🇺🇸 英語歌詞
                        <button class="copy-btn" onclick="copy('lyricsEN')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.lyricsEN}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🎨 Sunoスタイル
                        <button class="copy-btn" onclick="copy('stylePrompt')">📋 コピー</button>
                    </div>
                    <div class="result-content">${currentData.stylePrompt}</div>
                </div>
                
                <div class="result-box full-width">
                    <div class="result-header">
                        🖼️ Midjourney画像
                        <button class="copy-btn" onclick="copy('midjourneyPrompt')">📋 コピー</button>
                    </div>
                    <div class="controls">
                        <label>比率:</label>
                        <select id="aspectRatio" onchange="updateMjPrompt()">
                            <option value="1:1">1:1</option>
                            <option value="9:16">9:16</option>
                            <option value="16:9">16:9</option>
                        </select>
                        <label>モデル:</label>
                        <select id="model" onchange="updateMjPrompt()">
                            <option value="v 7">v 7</option>
                            <option value="niji 6">niji 6</option>
                        </select>
                    </div>
                    <div class="result-content" id="mjPrompt">${currentData.midjourneyPrompt} --ar 1:1 --v 7</div>
                </div>
            `;
        }
        
        // Midjourneyプロンプト更新
        function updateMjPrompt() {
            if (!currentData) return;
            
            const aspectRatio = document.getElementById('aspectRatio').value;
            const model = document.getElementById('model').value;
            const prompt = `${currentData.midjourneyPrompt} --ar ${aspectRatio} --${model}`;
            
            document.getElementById('mjPrompt').textContent = prompt;
        }
        
        // コピー機能
        function copy(type) {
            console.log('Copy function called with type:', type);
            console.log('Current data:', currentData);
            
            if (!currentData) {
                showMessage('❌ データがありません', 'error');
                return;
            }
            
            let text = '';
            switch(type) {
                case 'title': 
                    text = currentData.title; 
                    break;
                case 'lyricsJP': 
                    text = currentData.lyricsJP; 
                    break;
                case 'lyricsEN': 
                    text = currentData.lyricsEN; 
                    break;
                case 'stylePrompt': 
                    text = currentData.stylePrompt; 
                    break;
                case 'midjourneyPrompt': 
                    const aspectRatio = document.getElementById('aspectRatio')?.value || '1:1';
                    const model = document.getElementById('model')?.value || 'v 7';
                    text = `${currentData.midjourneyPrompt} --ar ${aspectRatio} --${model}`;
                    break;
                default:
                    showMessage('❌ 不明なタイプ', 'error');
                    return;
            }
            
            if (!text) {
                showMessage('❌ コピーするテキストがありません', 'error');
                return;
            }
            
            // コピー処理
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showMessage('📋 コピーしました');
                }).catch((err) => {
                    console.error('Clipboard API failed:', err);
                    fallbackCopy(text);
                });
            } else {
                fallbackCopy(text);
            }
        }
        
        // フォールバックコピー機能
        function fallbackCopy(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                textArea.setSelectionRange(0, 99999); // モバイル対応
                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                
                if (successful) {
                    showMessage('📋 コピーしました');
                } else {
                    showMessage('❌ コピーに失敗しました', 'error');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showMessage('❌ コピーに失敗しました', 'error');
            }
        }
        
        // メッセージ表示
        function showMessage(text, type = 'success') {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = 'message show ' + type;
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }
        
        // 初期化
        window.addEventListener('load', () => {
            // 保存されたAPI Keyを復元
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKey').value = savedKey;
            }
        });
    </script>
</body>
</html>