<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>🎵 Android Working Creator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            min-height: 100vh;
            padding: 15px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn:disabled {
            background: #999;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
        }
        
        /* コンテンツ編集可能エリア */
        .api-key-area {
            width: 100%;
            min-height: 60px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            background: white;
            color: #333;
            overflow-wrap: break-word;
            word-break: break-all;
            outline: none;
        }
        
        .api-key-area:focus {
            border-color: #667eea;
            background: #fafafa;
        }
        
        .api-key-area[contenteditable="true"]:empty:before {
            content: "ここをタップしてAPIキーを入力";
            color: #999;
        }
        
        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .help-text {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .theme-display {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            margin: 15px 0;
        }
        
        .result-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .result-header {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .result-content {
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 300px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .api-method-buttons {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }
        
        .method-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .method-btn:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .method-btn.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            align-items: center;
        }
        
        .controls label {
            font-weight: bold;
            color: #667eea;
        }
        
        .controls select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .controls select:focus {
            border-color: #667eea;
            outline: none;
        }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>🎵 Android Working Creator</h1>
        <div style="text-align: center; color: #666; margin-bottom: 20px;">
            Claude & Gemini AI 楽曲ジェネレーター（Android最適化）
        </div>
        
        <!-- API選択 -->
        <div class="section" style="background: linear-gradient(135deg, #FFE5EC, #E5E5FF);">
            <h3>🤖 AI API選択</h3>
            <div style="display: flex; gap: 10px; justify-content: center; margin: 15px 0;">
                <button class="method-btn active" id="apiClaude" onclick="selectAPI('claude')" style="flex: 1; max-width: 200px;">
                    🎭 Claude API
                </button>
                <button class="method-btn" id="apiGemini" onclick="selectAPI('gemini')" style="flex: 1; max-width: 200px;">
                    💎 Gemini API
                </button>
            </div>
        </div>
        
        <!-- API設定セクション -->
        <div class="section" id="apiSection">
            <h3 id="apiTitle">🎭 Claude API設定</h3>
            
            <div class="help-text">
                <strong>📱 APIキー入力方法を選択：</strong>
            </div>
            
            <div class="api-method-buttons">
                <button class="method-btn active" id="method1" onclick="selectMethod(1)">
                    方法1<br>プロンプト
                </button>
                <button class="method-btn" id="method2" onclick="selectMethod(2)">
                    方法2<br>直接入力
                </button>
                <button class="method-btn" id="method3" onclick="selectMethod(3)">
                    方法3<br>手動入力
                </button>
            </div>
            
            <!-- 方法1: プロンプトダイアログ -->
            <div id="method1Content" style="display: block;">
                <button class="btn btn-warning" onclick="promptForApiKey()">
                    📝 APIキーを入力（ダイアログ）
                </button>
                <div id="promptResult" style="margin-top: 10px; font-family: monospace; font-size: 12px; color: #666;"></div>
            </div>
            
            <!-- 方法2: コンテンツ編集可能div -->
            <div id="method2Content" style="display: none;">
                <div class="help-text" style="background: #fff3cd; border-color: #ffc107;">
                    下の枠内をタップして、APIキーを直接入力または貼り付けてください
                </div>
                <div 
                    id="apiKeyDiv" 
                    class="api-key-area"
                    contenteditable="true"
                    spellcheck="false"
                    autocomplete="off"
                    autocorrect="off"
                    autocapitalize="off"
                    oninput="onApiKeyDivChange()"
                ></div>
                <div id="divCharCount" style="text-align: right; font-size: 12px; color: #666; margin-top: 5px;">0文字</div>
            </div>
            
            <!-- 方法3: ボタンごとに文字入力 -->
            <div id="method3Content" style="display: none;">
                <div class="help-text" style="background: #f0f8ff; border-color: #2196F3;">
                    各ボタンをタップしてAPIキーを1文字ずつ入力
                </div>
                <div id="manualInput" style="font-family: monospace; padding: 10px; background: #f8f9fa; border-radius: 5px; margin: 10px 0; min-height: 40px; word-break: break-all;"></div>
                <div style="display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin: 10px 0;">
                    <button onclick="addChar('A')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">A</button>
                    <button onclick="addChar('I')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">I</button>
                    <button onclick="addChar('z')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">z</button>
                    <button onclick="addChar('a')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">a</button>
                    <button onclick="addChar('S')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">S</button>
                    <button onclick="addChar('y')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">y</button>
                    <button onclick="addChar('0')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">0</button>
                    <button onclick="addChar('1')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">1</button>
                    <button onclick="addChar('2')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">2</button>
                    <button onclick="addChar('3')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">3</button>
                    <button onclick="addChar('4')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">4</button>
                    <button onclick="addChar('5')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">5</button>
                    <button onclick="addChar('6')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">6</button>
                    <button onclick="addChar('7')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">7</button>
                    <button onclick="addChar('8')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">8</button>
                    <button onclick="addChar('9')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">9</button>
                    <button onclick="addChar('-')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">-</button>
                    <button onclick="addChar('_')" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px;">_</button>
                    <button onclick="deleteChar()" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; grid-column: span 2;">⌫</button>
                </div>
                <button class="btn btn-danger" onclick="clearManualInput()" style="padding: 10px;">クリア</button>
            </div>
            
            <!-- 共通ボタン -->
            <button class="btn" onclick="testConnection()" id="testBtn">
                🔌 接続テスト
            </button>
            
            <button class="btn btn-danger" onclick="clearApiKey()">
                🗑️ APIキークリア
            </button>
            
            <div id="apiStatus"></div>
        </div>
        
        <!-- テーマ生成 -->
        <div class="section">
            <h3>🎯 楽曲テーマ</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-secondary" onclick="generateAITheme()" id="aiThemeBtn" style="flex: 2;">
                    🤖 AIバズテーマ生成
                </button>
                <button class="btn" onclick="generateRandomTheme()" id="randomThemeBtn" style="flex: 1; background: linear-gradient(135deg, #28a745, #20c997);">
                    🎲 ランダム
                </button>
            </div>
            <div class="theme-display" id="themeDisplay">
                テーマを生成してください
            </div>
        </div>
        
        <!-- 楽曲生成 -->
        <div class="section">
            <button class="btn" onclick="generateSong()" id="generateBtn" disabled>
                🚀 3分楽曲を生成（要API接続）
            </button>
        </div>
        
        <!-- 結果表示 -->
        <div id="results"></div>
    </div>
    
    <script>
        let apiKey = '';
        let apiConnected = false;
        let currentTheme = '';
        let isGenerating = false;
        let selectedMethod = 1;
        let manualApiKey = '';
        let currentArtwork = '';
        let currentData = {};
        let selectedAPI = 'claude';  // デフォルトはClaude
        let generatedThemes = [];  // 生成済みテーマの履歴
        
        // バズりやすいテーマリスト（予備用）
        const fallbackThemes = [
            // 恋愛系
            '推しに背中を押された夏', 'バイト先の奇跡の恋', 'スマホ越しの初恋',
            'AI彼女との約束', 'メタバース初デート', '終電で始まる青春',
            
            // 友情・絆系  
            'ゲーム仲間との絆', '深夜ラジオの約束', 'オンライン授業の友情',
            '文化祭前夜の奇跡', '卒業式の空っぽな教室', '同級生への感謝の歌',
            
            // 夢・成長系
            '夢を追いかける勇気', '諦めない心の歌', 'YouTuberへの憧憬',
            '18歳の決意表明', '親への感謝の手紙', '失敗から学んだ強さ',
            
            // 日常の奇跡系
            '深夜コンビニの奇跡', '雨の日の小さな発見', '通学路の季節',
            'カフェで見つけた希望', '図書館での出会い', '電車の中の風景',
            
            // 現代的テーマ
            'TikTokで有名になった日', 'インスタライブの向こう側', 'ゲーム実況者への道',
            'Vtuberとしての第一歩', 'ボカロPになる夢', 'プログラマーの恋'
        ];
        
        // 初期化
        window.onload = function() {
            // 保存されたAPIキーを復元
            const savedClaude = localStorage.getItem('claudeApiKey');
            const savedGemini = localStorage.getItem('geminiApiKey');
            
            if (savedClaude) {
                selectedAPI = 'claude';
                apiKey = savedClaude;
                displayApiKey();
                setTimeout(() => testConnection(), 1000);
            } else if (savedGemini) {
                selectedAPI = 'gemini';
                selectAPI('gemini');
                apiKey = savedGemini;
                displayApiKey();
                setTimeout(() => testConnection(), 1000);
            }
        };
        
        // API選択
        function selectAPI(api) {
            selectedAPI = api;
            document.getElementById('apiClaude').classList.remove('active');
            document.getElementById('apiGemini').classList.remove('active');
            document.getElementById('api' + api.charAt(0).toUpperCase() + api.slice(1)).classList.add('active');
            
            const apiTitle = document.getElementById('apiTitle');
            const promptResult = document.getElementById('promptResult');
            
            if (api === 'claude') {
                apiTitle.innerHTML = '🎭 Claude API設定';
                apiKey = localStorage.getItem('claudeApiKey') || '';
            } else {
                apiTitle.innerHTML = '💎 Gemini API設定';
                apiKey = localStorage.getItem('geminiApiKey') || '';
            }
            
            // 表示をリセット
            displayApiKey();
            apiConnected = false;
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('apiStatus').innerHTML = '';
        }
        
        // 入力方法選択
        function selectMethod(method) {
            selectedMethod = method;
            
            // ボタンの状態更新
            document.querySelectorAll('.method-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById('method' + method).classList.add('active');
            
            // コンテンツ表示切り替え
            document.getElementById('method1Content').style.display = method === 1 ? 'block' : 'none';
            document.getElementById('method2Content').style.display = method === 2 ? 'block' : 'none';
            document.getElementById('method3Content').style.display = method === 3 ? 'block' : 'none';
        }
        
        // 方法1: プロンプトダイアログ
        function promptForApiKey() {
            const apiName = selectedAPI === 'claude' ? 'Claude' : 'Gemini';
            const format = selectedAPI === 'claude' ? 'sk-ant-api...で始まる100文字程度' : 'AIzaSy...で始まる40文字程度';
            
            const input = prompt(`${apiName} APIキーを入力してください（${format}）:`);
            if (input && input.trim()) {
                apiKey = input.trim();
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                displayApiKey();
                document.getElementById('apiStatus').innerHTML = '<div class="status warning">APIキーを保存しました。接続テストを実行してください。</div>';
            }
        }
        
        // 方法2: div入力変更時
        function onApiKeyDivChange() {
            const div = document.getElementById('apiKeyDiv');
            const text = div.textContent || div.innerText || '';
            const count = document.getElementById('divCharCount');
            
            count.textContent = text.length + '文字';
            
            const isValid = (selectedAPI === 'claude' && text.startsWith('sk-ant-api') && text.length >= 100) ||
                           (selectedAPI === 'gemini' && text.startsWith('AIzaSy') && text.length >= 39);
            
            if (isValid) {
                apiKey = text.trim();
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                count.innerHTML = text.length + '文字 <span style="color: green;">✅</span>';
            } else if (text.length > 0) {
                count.innerHTML = text.length + '文字 <span style="color: orange;">⚠️</span>';
            }
        }
        
        // 方法3: 手動文字入力
        function addChar(char) {
            manualApiKey += char;
            document.getElementById('manualInput').textContent = manualApiKey;
            
            const isValid = (selectedAPI === 'claude' && manualApiKey.startsWith('sk-ant-api') && manualApiKey.length >= 100) ||
                           (selectedAPI === 'gemini' && manualApiKey.startsWith('AIzaSy') && manualApiKey.length >= 39);
            
            if (isValid) {
                apiKey = manualApiKey;
                localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                document.getElementById('apiStatus').innerHTML = '<div class="status success">✅ 有効なAPIキー形式です</div>';
            }
        }
        
        function deleteChar() {
            if (manualApiKey.length > 0) {
                manualApiKey = manualApiKey.slice(0, -1);
                document.getElementById('manualInput').textContent = manualApiKey;
            }
        }
        
        function clearManualInput() {
            manualApiKey = '';
            document.getElementById('manualInput').textContent = '';
        }
        
        // APIキー表示
        function displayApiKey() {
            if (apiKey) {
                const masked = apiKey.substring(0, 10) + '...' + apiKey.substring(apiKey.length - 5);
                document.getElementById('promptResult').textContent = 'APIキー: ' + masked;
                document.getElementById('apiKeyDiv').textContent = apiKey;
                document.getElementById('manualInput').textContent = apiKey;
                manualApiKey = apiKey;
                onApiKeyDivChange();
            }
        }
        
        // APIキークリア
        function clearApiKey() {
            if (confirm('APIキーをクリアしますか？')) {
                apiKey = '';
                manualApiKey = '';
                localStorage.removeItem(selectedAPI + 'ApiKey');
                apiConnected = false;
                document.getElementById('generateBtn').disabled = true;
                document.getElementById('apiStatus').innerHTML = '';
                document.getElementById('promptResult').textContent = '';
                document.getElementById('apiKeyDiv').textContent = '';
                document.getElementById('manualInput').textContent = '';
                document.getElementById('divCharCount').textContent = '0文字';
                alert('APIキーをクリアしました');
            }
        }
        
        // API接続テスト
        async function testConnection() {
            const status = document.getElementById('apiStatus');
            const testBtn = document.getElementById('testBtn');
            const generateBtn = document.getElementById('generateBtn');
            
            // 現在の入力方法から取得
            if (selectedMethod === 2) {
                const div = document.getElementById('apiKeyDiv');
                const text = (div.textContent || div.innerText || '').trim();
                const isValid = (selectedAPI === 'claude' && text.startsWith('sk-ant-api')) ||
                               (selectedAPI === 'gemini' && text.startsWith('AIzaSy'));
                if (isValid) {
                    apiKey = text;
                }
            } else if (selectedMethod === 3) {
                const isValid = (selectedAPI === 'claude' && manualApiKey.startsWith('sk-ant-api')) ||
                               (selectedAPI === 'gemini' && manualApiKey.startsWith('AIzaSy'));
                if (isValid) {
                    apiKey = manualApiKey;
                }
            }
            
            if (!apiKey) {
                status.innerHTML = '<div class="status error">❌ APIキーを入力してください</div>';
                return;
            }
            
            const validFormat = (selectedAPI === 'claude' && apiKey.startsWith('sk-ant-api')) ||
                              (selectedAPI === 'gemini' && apiKey.startsWith('AIzaSy'));
            
            if (!validFormat) {
                status.innerHTML = '<div class="status error">❌ 無効なAPIキー形式です</div>';
                return;
            }
            
            testBtn.disabled = true;
            testBtn.textContent = '🔄 テスト中...';
            status.innerHTML = '<div class="status warning">⏳ 接続テスト中...</div>';
            
            try {
                let response;
                try {
                    const endpoint = selectedAPI === 'claude' ? '/api/claude' : '/api/gemini';
                    response = await fetch('http://localhost:3000' + endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            apiKey: apiKey,
                            prompt: 'Hello test',
                            temperature: 0.1
                        })
                    });
                } catch (fetchError) {
                    throw new Error('サーバーに接続できません。api-server.jsが起動しているか確認してください');
                }
                
                let data;
                try {
                    data = await response.json();
                } catch (jsonError) {
                    throw new Error('サーバーからの応答が不正です');
                }
                
                if (response.ok && (data.content || data.candidates)) {
                    apiConnected = true;
                    generateBtn.disabled = false;
                    status.innerHTML = '<div class="status success">✅ 接続成功！AI生成が利用可能です</div>';
                    localStorage.setItem(selectedAPI + 'ApiKey', apiKey);
                } else {
                    // エラーオブジェクトの処理を改善
                    let errorMessage = 'Connection failed';
                    if (data.error) {
                        if (typeof data.error === 'string') {
                            errorMessage = data.error;
                        } else if (data.error.message) {
                            errorMessage = data.error.message;
                        } else if (data.error.error) {
                            errorMessage = data.error.error;
                        } else {
                            errorMessage = JSON.stringify(data.error);
                        }
                    }
                    throw new Error(errorMessage);
                }
            } catch (error) {
                apiConnected = false;
                generateBtn.disabled = true;
                const errorMsg = error.message || 'Unknown error';
                console.error('Connection error:', error);
                
                // エラーメッセージの詳細判定
                let helpMessage = 'api-server.jsが起動していることを確認してください';
                if (errorMsg.includes('API key not valid')) {
                    helpMessage = 'APIキーが無効です。正しいAPIキーを入力してください';
                } else if (errorMsg.includes('quota') || errorMsg.includes('rate limit')) {
                    helpMessage = 'APIの利用制限に達しました。無料枠は1日1,500リクエストです';
                } else if (errorMsg.includes('サーバーに接続できません')) {
                    helpMessage = 'api-server.jsが起動していない可能性があります';
                }
                
                status.innerHTML = `<div class="status error">❌ 接続失敗: ${errorMsg}<br>${helpMessage}</div>`;
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = '🔌 接続テスト';
            }
        }
        
        // AIテーマ生成（バズりやすいテーマ）
        async function generateAITheme() {
            const btn = document.getElementById('aiThemeBtn');
            const display = document.getElementById('themeDisplay');
            
            if (!apiConnected) {
                alert('先にAPI接続テストを成功させてください');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '🤖 生成中...';
            display.textContent = 'AIがバズるテーマを考案中...';
            
            try {
                // ランダム要素を追加して多様性を確保
                const timeStamp = new Date().getTime();
                const randomSeed = Math.floor(Math.random() * 1000);
                
                // テーマのカテゴリーをランダムに選択
                const categories = [
                    '恋愛・青春', '友情・絆', '夢・挑戦', '日常の奇跡', 
                    'SNS・デジタル', '成長・自己肯定', '家族・感謝', '別れ・出会い'
                ];
                const selectedCategory = categories[Math.floor(Math.random() * categories.length)];
                
                // トレンドワードをランダムに選択
                const trendWords = [
                    '推し', 'エモい', 'ガチ恋', 'ワンチャン', 'リアコ',
                    'バズる', 'インスタ映え', 'TikTok', 'オンライン',
                    '課金', 'ソロ活', 'ヲタ活', 'チル', 'フォトジェニック'
                ];
                const trendWord = trendWords[Math.floor(Math.random() * trendWords.length)];
                
                const prompt = `【シード値: ${randomSeed}】
2024年にSNSでバズりそうな楽曲テーマを1つ生成してください。

【カテゴリー】${selectedCategory}
【トレンドワード】${trendWord}を参考にしても良い

【必須条件】
- 前向きで共感を呼ぶ内容
- 感動や勇気を与える
- Z世代（10代-20代）が共感できる
- 15文字以内の短いフレーズ
- 今まで生成したものと違う新しいテーマ

【NG例（これらと似たものは避ける）】
- 推しに背中を押された夏
- バイト先の奇跡の恋
- 深夜ラジオの約束
${generatedThemes.length > 0 ? '- ' + generatedThemes.join('\n- ') : ''}

独創的で新しいテーマを1つだけ出力してください。説明は不要です。`;

                let theme = await callAI(prompt);
                // 改行や余分な文字を削除
                theme = theme.trim().replace(/[\n\r]/g, '').replace(/^[「『"']|[」』"']$/g, '');
                
                // 15文字を超えたら短縮
                if (theme.length > 15) {
                    theme = theme.substring(0, 15);
                }
                
                currentTheme = theme;
                display.textContent = '🔥 ' + currentTheme;
                
                // 生成履歴に追加（最大10個保持）
                generatedThemes.push(theme);
                if (generatedThemes.length > 10) {
                    generatedThemes.shift();
                }
                
            } catch (error) {
                console.error('AI theme generation failed:', error);
                // フォールバック：ランダムテーマ
                generateRandomTheme();
                alert('AIテーマ生成に失敗しました。ランダムテーマを使用します。');
            } finally {
                btn.disabled = false;
                btn.textContent = '🤖 AIバズテーマ生成';
            }
        }
        
        // ランダムテーマ生成（予備）
        function generateRandomTheme() {
            currentTheme = fallbackThemes[Math.floor(Math.random() * fallbackThemes.length)];
            document.getElementById('themeDisplay').textContent = '🎲 ' + currentTheme;
        }
        
        // 楽曲生成
        async function generateSong() {
            if (!currentTheme) {
                alert('先にテーマを生成してください');
                return;
            }
            
            if (!apiConnected) {
                alert('先にAPI接続テストを成功させてください');
                return;
            }
            
            if (isGenerating) return;
            
            const btn = document.getElementById('generateBtn');
            const results = document.getElementById('results');
            
            isGenerating = true;
            btn.disabled = true;
            btn.textContent = '🔄 生成中...';
            
            results.innerHTML = '<div class="status warning">🎵 楽曲を生成中...</div>';
            
            try {
                // タイトル生成
                const title = await callAI(`"${currentTheme}"の楽曲タイトルを1つ生成してください。印象的で覚えやすいタイトル。タイトルのみ出力。`);
                
                // 日本語歌詞生成（3分楽曲用）
                const lyricsJP = await callAI(`${currentTheme}の日本語歌詞を作成してください。3分程度の楽曲を想定して、以下の構成で作成してください：
[Intro] (2行)
[Verse 1] (4行)
[Pre-Chorus] (2行)
[Chorus] (4行)
[Verse 2] (4行)
[Pre-Chorus] (2行)
[Chorus] (4行)
[Bridge] (4行)
[Chorus] (4行)
[Outro] (2行)

合計32行程度。各パートは簡潔に、感情を込めて。歌詞のみを出力してください。`);
                
                // 英語歌詞生成（3分楽曲用）
                const lyricsEN = await callAI(`${currentTheme}の英語歌詞を作成してください。3分程度の楽曲を想定して、以下の構成で作成してください：
[Intro] (2行)
[Verse 1] (4行)
[Pre-Chorus] (2行)
[Chorus] (4行)
[Verse 2] (4行)
[Pre-Chorus] (2行)
[Chorus] (4行)
[Bridge] (4行)
[Chorus] (4行)
[Outro] (2行)

合計32行程度。簡潔でキャッチーな英語歌詞。歌詞のみを出力してください。`);
                
                // スタイル生成
                const style = await callAI(`"${currentTheme}"の音楽スタイルを生成してください。ジャンル、ムード、BPMを含めて20語以内で。`);
                
                // Midjourneyプロンプト生成（30字以内）
                const artwork = await callAI(`"${currentTheme}"のMidjourneyプロンプトを英語30字以内で生成。簡漁に。`);
                
                // アートワークを保存
                currentArtwork = artwork;
                
                // データを保存
                currentData = {
                    title: title,
                    lyricsJP: lyricsJP,
                    lyricsEN: lyricsEN,
                    style: style,
                    artwork: artwork
                };
                
                // 結果表示
                displayResults(currentData);
                
            } catch (error) {
                results.innerHTML = `<div class="status error">❌ 生成エラー: ${error.message}</div>`;
            } finally {
                isGenerating = false;
                btn.disabled = false;
                btn.textContent = '🚀 3分楽曲を生成（要API接続）';
            }
        }
        
        // AI API呼び出し（Claude/Gemini両対応）
        async function callAI(prompt) {
            const endpoint = selectedAPI === 'claude' ? '/api/claude' : '/api/gemini';
            
            const response = await fetch('http://localhost:3000' + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    apiKey: apiKey,
                    prompt: prompt,
                    temperature: 0.9
                })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'API Error');
            }
            
            // Claude APIのレスポンス形式
            if (selectedAPI === 'claude' && data.content && data.content[0]) {
                return data.content[0].text;
            }
            // Gemini APIのレスポンス形式
            else if (selectedAPI === 'gemini' && data.candidates && data.candidates[0]) {
                return data.candidates[0].content.parts[0].text;
            }
            else {
                throw new Error('No response from API');
            }
        }
        
        // 結果表示
        function displayResults(content) {
            const results = document.getElementById('results');
            
            results.innerHTML = `
                <div class="result-box">
                    <div class="result-header">
                        🎵 楽曲タイトル
                        <button class="copy-btn" onclick="copyTitle()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="titleContent">${content.title}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🎌 日本語歌詞（3分楽曲用）
                        <button class="copy-btn" onclick="copyLyricsJP()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="lyricsJPContent">${content.lyricsJP}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🇺🇸 英語歌詞（3分楽曲用）
                        <button class="copy-btn" onclick="copyLyricsEN()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="lyricsENContent">${content.lyricsEN}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🎨 音楽スタイル
                        <button class="copy-btn" onclick="copyStyle()">📋 コピー</button>
                    </div>
                    <div class="result-content" id="styleContent">${content.style}</div>
                </div>
                
                <div class="result-box">
                    <div class="result-header">
                        🖼️ Midjourneyアートワーク
                        <button class="copy-btn" onclick="copyArtwork()">📋 コピー</button>
                    </div>
                    <div class="controls">
                        <label>比率:</label>
                        <select id="aspectRatio" onchange="updateMjPrompt()">
                            <option value="1:1">1:1</option>
                            <option value="9:16">9:16</option>
                            <option value="16:9">16:9</option>
                        </select>
                        <label>モデル:</label>
                        <select id="model" onchange="updateMjPrompt()">
                            <option value="v 7">v 7</option>
                            <option value="niji 6">niji 6</option>
                        </select>
                    </div>
                    <div class="result-content" id="artworkContent">${content.artwork} --ar 1:1 --v 7</div>
                </div>
            `;
        }
        
        // コピー機能
        function copyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            
            try {
                document.execCommand('copy');
                alert('📋 コピーしました！');
            } catch (err) {
                alert('コピーに失敗しました。手動でコピーしてください。');
            }
            
            document.body.removeChild(textArea);
        }
        
        // 日本語歌詞コピー専用
        function copyLyricsJP() {
            const lyrics = document.getElementById('lyricsJPContent').textContent;
            copyText(lyrics);
        }
        
        // 英語歌詞コピー専用
        function copyLyricsEN() {
            const lyrics = document.getElementById('lyricsENContent').textContent;
            copyText(lyrics);
        }
        
        // Midjourneyプロンプト更新
        function updateMjPrompt() {
            if (!currentArtwork) return;
            
            const aspectRatio = document.getElementById('aspectRatio').value;
            const model = document.getElementById('model').value;
            const prompt = `${currentArtwork} --ar ${aspectRatio} --${model}`;
            
            document.getElementById('artworkContent').textContent = prompt;
        }
        
        // タイトルコピー専用
        function copyTitle() {
            const title = document.getElementById('titleContent').textContent;
            copyText(title);
        }
        
        // スタイルコピー専用
        function copyStyle() {
            const style = document.getElementById('styleContent').textContent;
            copyText(style);
        }
        
        // アートワークコピー専用
        function copyArtwork() {
            const artwork = document.getElementById('artworkContent').textContent;
            copyText(artwork);
        }
    </script>
</body>
</html>